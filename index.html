import React, { useState, useEffect, useMemo } from 'react';
import { 
  Heart, CloudSun, Navigation, PencilLine, Plus, 
  ChevronLeft, CalendarPlus, Banknote, Coins, 
  Trash2, RefreshCw, Luggage, Hotel, Sparkles, MapPinned
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, collection, query, onSnapshot, 
  deleteDoc, updateDoc, serverTimestamp 
} from 'firebase/firestore';

// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'fukuoka-trip-2026';

const App = () => {
  // --- ç‹€æ…‹ç®¡ç† ---
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('itinerary'); // itinerary, expense, tools
  const [itineraryView, setItineraryView] = useState('list'); // list, detail
  const [selectedDayIdx, setSelectedDayIdx] = useState(0);
  const [itineraryData, setItineraryData] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [weather, setWeather] = useState({ temp: 24, icon: 'cloud-sun' });
  const [isEditingPlan, setIsEditingPlan] = useState(false);
  const [editingPlan, setEditingPlan] = useState(null);
  const [editPlanBuffer, setEditPlanBuffer] = useState({ time: '', title: '' });
  const [exchangeRate] = useState(0.211);
  const [fxInput, setFxInput] = useState('');
  const [newExpense, setNewExpense] = useState({ date: new Date().toISOString().split('T')[0], payer: 'KCY', item: '', amount: '' });
  const [isSaving, setIsSaving] = useState(false);

  const members = ['KCY', 'Ruby', 'YSL', 'Tsai'];
  const dates = [
    { date: '5/30', dayName: 'SAT' }, { date: '5/31', dayName: 'SUN' },
    { date: '6/1', dayName: 'MON' }, { date: '6/2', dayName: 'TUE' },
    { date: '6/3', dayName: 'WED' }, { date: '6/4', dayName: 'THU' },
    { date: '6/5', dayName: 'FRI' }, { date: '6/6', dayName: 'SAT' }
  ];

  // --- (1) èº«ä»½é©—è­‰ ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- (2) é›²ç«¯è³‡æ–™ç›£è½ (å³æ™‚åŒæ­¥é—œéµ) ---
  useEffect(() => {
    if (!user) return;

    // ç›£è½è¡Œç¨‹
    const itineraryCol = collection(db, 'artifacts', appId, 'public', 'data', 'itinerary');
    const unsubItinerary = onSnapshot(itineraryCol, (snapshot) => {
      const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setItineraryData(docs);
    }, (err) => console.error("è¡Œç¨‹åŒæ­¥éŒ¯èª¤:", err));

    // ç›£è½è¨˜å¸³
    const expenseCol = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
    const unsubExpense = onSnapshot(expenseCol, (snapshot) => {
      const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      // æŒ‰æ—¥æœŸæ’åº
      const sorted = docs.sort((a, b) => new Date(b.date) - new Date(a.date));
      setExpenses(sorted);
    }, (err) => console.error("è¨˜å¸³åŒæ­¥éŒ¯èª¤:", err));

    return () => {
      unsubItinerary();
      unsubExpense();
    };
  }, [user]);

  // --- è¡ç”Ÿè³‡æ–™ ---
  const currentDayPlans = useMemo(() => {
    const targetDate = dates[selectedDayIdx].date;
    return itineraryData
      .filter(p => p.targetDate === targetDate)
      .sort((a, b) => a.time.replace(':', '') - b.time.replace(':', ''));
  }, [itineraryData, selectedDayIdx]);

  // --- æ“ä½œé‚è¼¯ ---
  const handleAddPlan = () => {
    setEditingPlan(null);
    setEditPlanBuffer({ time: '', title: '' });
    setIsEditingPlan(true);
  };

  const handleEditPlan = (plan) => {
    setEditingPlan(plan);
    setEditPlanBuffer({ time: plan.time, title: plan.title });
    setIsEditingPlan(true);
  };

  const savePlan = async () => {
    if (!editPlanBuffer.time || !editPlanBuffer.title) return;
    setIsSaving(true);
    try {
      const planId = editingPlan ? editingPlan.id : `plan-${Date.now()}`;
      const planRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', planId);
      await setDoc(planRef, {
        ...editPlanBuffer,
        targetDate: dates[selectedDayIdx].date,
        updatedAt: serverTimestamp()
      }, { merge: true });
      setIsEditingPlan(false);
    } catch (e) {
      console.error(e);
    } finally {
      setIsSaving(false);
    }
  };

  const deletePlan = async (id) => {
    if (!window.confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', id));
  };

  const addExpense = async () => {
    if (!newExpense.item || !newExpense.amount) return;
    setIsSaving(true);
    try {
      const id = `exp-${Date.now()}`;
      const expRef = doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id);
      await setDoc(expRef, {
        ...newExpense,
        amount: parseFloat(newExpense.amount),
        amountTwd: Math.round(parseFloat(newExpense.amount) * exchangeRate),
        createdAt: serverTimestamp()
      });
      setNewExpense({ ...newExpense, item: '', amount: '' });
    } catch (e) {
      console.error(e);
    } finally {
      setIsSaving(false);
    }
  };

  const deleteExpense = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
  };

  const openMap = (query) => {
    const target = query.includes('å›é£¯åº—') ? 'åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—' : query;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(target)}`, '_blank');
  };

  // --- UI çµ„ä»¶ ---
  return (
    <div className="max-w-md mx-auto min-h-screen relative pb-32 bg-[#F9F7FC] text-[#2D2727]" 
         style={{ backgroundImage: 'radial-gradient(#9D76C1 0.5px, transparent 0.5px)', backgroundSize: '20px 20px' }}>
      
      {/* å¯æ„›å­—é«”æ¨£å¼æ³¨å…¥ */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        body { font-family: 'ZCOOL KuaiLe', cursive; }
        .kuromi-gradient { background: linear-gradient(135deg, #9D76C1 0%, #765898 100%); }
      `}</style>

      {/* Header */}
      <header className="kuromi-gradient text-white p-10 pt-16 rounded-b-[80px] shadow-2xl relative">
        <div className="flex justify-between items-center relative z-10">
          <div className="flex-1">
            <h1 className="text-6xl font-bold tracking-tight" style={{ textShadow: '4px 4px 0px rgba(0,0,0,0.2)' }}>ç¦å²¡ 2026</h1>
            <div className="flex items-center gap-2 mt-4">
              <span className="bg-black/30 px-5 py-2 rounded-full text-xs font-bold tracking-[0.3em]">KCY FAMILY</span>
              <Heart className="w-6 h-6 fill-pink-400 text-pink-400" />
            </div>
          </div>
          <div className="bg-black/40 p-6 rounded-[50px] backdrop-blur-xl text-center border-2 border-white/20 min-w-[130px] shadow-2xl">
            <CloudSun className="w-14 h-14 mx-auto mb-1 text-[#FF91C1]" />
            <p className="text-4xl font-black">{weather.temp}Â°C</p>
            <p className="text-xs opacity-80 uppercase mt-1 tracking-widest font-bold">Fukuoka</p>
          </div>
        </div>
      </header>

      {/* å°è¦½é ç±¤ */}
      {itineraryView === 'list' && (
        <nav className="flex bg-white/95 backdrop-blur-lg sticky top-0 z-50 px-8 mt-4 border-b-6 border-purple-100 shadow-lg">
          {['itinerary', 'expense', 'tools'].map(tab => (
            <button 
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`flex-1 py-7 font-black text-xl transition-all ${activeTab === tab ? 'text-[#9D76C1] border-b-8 border-[#9D76C1]' : 'text-slate-400'}`}
            >
              {tab === 'itinerary' ? 'è¡Œç¨‹' : tab === 'expense' ? 'è¨˜å¸³' : 'å·¥å…·'}
            </button>
          ))}
        </nav>
      )}

      {/* å…§å®¹å€ */}
      <div className="px-8 py-10">
        
        {/* (1) è¡Œç¨‹åˆ†é  */}
        {activeTab === 'itinerary' && (
          <>
            {itineraryView === 'list' ? (
              <div className="space-y-8 animate-in fade-in duration-500">
                <h2 className="text-3xl font-black text-slate-800">å†’éšªå‡ºç™¼ï¼ ğŸ’œ</h2>
                <div className="grid grid-cols-2 gap-6">
                  {dates.map((day, idx) => (
                    <div 
                      key={day.date}
                      onClick={() => { setSelectedDayIdx(idx); setItineraryView('detail'); }}
                      className="bg-white rounded-[45px] p-10 flex flex-col items-center justify-center text-center shadow-2xl border-4 border-[#E2D9F3] border-b-[12px] border-b-[#9D76C1] active:scale-95 transition-transform relative"
                    >
                      <span className="text-sm font-black text-purple-300 uppercase mb-2">{day.dayName}</span>
                      <span className="text-7xl font-black text-slate-700 mb-4">{day.date.split('/')[1]}</span>
                      <span className="text-xs font-black text-white bg-purple-400 px-5 py-2 rounded-full">{day.date}</span>
                      {itineraryData.some(p => p.targetDate === day.date) && (
                        <div className="absolute top-6 right-6 w-5 h-5 bg-pink-400 rounded-full animate-pulse border-4 border-white shadow-lg" />
                      )}
                    </div>
                  ))}
                </div>
                <button onClick={() => openMap('https://maps.app.goo.gl/pd5Mgn8orC6EG7dc6')} className="w-full bg-[#2D2727] text-white py-8 rounded-[50px] flex items-center justify-center gap-5 shadow-2xl active:scale-95 border-4 border-purple-900/10">
                  <MapPinned className="text-pink-400 w-10 h-10" />
                  <span className="font-black text-2xl tracking-wider">é–‹å•Ÿåœ°åœ–æ™¯é» ğŸ’œ</span>
                </button>
              </div>
            ) : (
              <div className="space-y-10 animate-in slide-in-from-bottom duration-500">
                <div className="flex items-center gap-6">
                  <button onClick={() => setItineraryView('list')} className="p-6 bg-white rounded-full shadow-xl text-purple-600 active:scale-75 transition-all border-2 border-purple-50">
                    <ChevronLeft className="w-10 h-10" />
                  </button>
                  <div>
                    <h2 className="text-5xl font-black text-slate-800 tracking-tight">{dates[selectedDayIdx].date}</h2>
                    <p className="text-sm font-black text-purple-400 uppercase mt-2 tracking-widest">æœ¬æ—¥å†’éšªè¨ˆç•«</p>
                  </div>
                </div>

                <button onClick={handleAddPlan} className="w-full bg-white border-4 border-dashed border-purple-200 text-purple-500 py-10 rounded-[50px] flex items-center justify-center gap-4 active:scale-95 transition-all shadow-inner hover:bg-purple-50">
                  <CalendarPlus className="w-10 h-10" />
                  <span className="font-black text-3xl">æ–°å¢è¡Œç¨‹ ğŸ’œ</span>
                </button>

                <div className="space-y-8">
                  {currentDayPlans.map(plan => (
                    <div key={plan.id} className="bg-white rounded-[45px] border-4 border-[#E2D9F3] p-10 flex flex-col shadow-2xl border-l-[25px] border-l-[#9D76C1]">
                      <div className="flex justify-between items-start mb-8">
                        <span className="text-xl font-black text-white bg-slate-800 px-6 py-2.5 rounded-full shadow-xl">{plan.time}</span>
                        <div className="flex gap-4">
                          <button onClick={() => handleEditPlan(plan)} className="p-5 bg-purple-50 text-purple-400 rounded-full active:scale-75 shadow-sm"><PencilLine className="w-8 h-8" /></button>
                          <button onClick={() => openMap(plan.title)} className="p-5 bg-pink-50 text-pink-400 rounded-full active:scale-75 shadow-sm"><Navigation className="w-8 h-8" /></button>
                          <button onClick={() => deletePlan(plan.id)} className="p-5 bg-red-50 text-red-400 rounded-full active:scale-75 shadow-sm"><Trash2 className="w-8 h-8" /></button>
                        </div>
                      </div>
                      <h3 className="text-4xl font-black text-slate-700 leading-tight">{plan.title}</h3>
                    </div>
                  ))}
                  {currentDayPlans.length === 0 && (
                    <div className="py-40 text-center opacity-20">
                      <Sparkles className="w-24 h-24 mx-auto mb-8 text-purple-200" />
                      <p className="font-black text-3xl uppercase tracking-widest">ç›®å‰æ²’è¨ˆç•«å”·</p>
                    </div>
                  )}
                </div>
              </div>
            )}
          </>
        )}

        {/* (2) è¨˜å¸³åˆ†é  */}
        {activeTab === 'expense' && (
          <div className="space-y-12 animate-in fade-in duration-500">
            {/* åŒ¯ç‡å¡ç‰‡ */}
            <div className="bg-[#2D2727] text-white p-12 rounded-[50px] shadow-2xl relative overflow-hidden">
              <div className="absolute -right-6 -bottom-6 opacity-10"><Coins className="w-40 h-40" /></div>
              <p className="text-md text-[#FF91C1] font-black uppercase tracking-[0.3em] mb-8">JPY â®• TWD å³æ™‚æ›ç®—</p>
              <div className="flex items-center justify-between">
                <input 
                  type="number" 
                  value={fxInput} 
                  onChange={(e) => setFxInput(e.target.value)}
                  placeholder="0" 
                  className="flex-1 bg-transparent text-7xl font-black focus:outline-none placeholder:text-white/10 tracking-tighter" 
                />
                <div className="text-right">
                  <p className="text-xs opacity-40 font-black mb-1">NT$</p>
                  <p className="text-6xl font-black text-[#FF91C1] tracking-tighter">
                    {Math.round((parseFloat(fxInput) || 0) * exchangeRate).toLocaleString()}
                  </p>
                </div>
              </div>
              <div className="mt-10 pt-8 border-t border-white/10 flex justify-between text-sm text-slate-500 font-black tracking-widest">
                <span>1 JPY = {exchangeRate} TWD</span>
              </div>
            </div>

            {/* æ–°å¢æ”¯å‡º */}
            <div className="bg-white rounded-[50px] p-12 space-y-10 shadow-2xl border-[6px] border-purple-100">
              <div className="flex justify-between items-center">
                <h3 className="text-3xl font-black text-slate-800 italic underline decoration-pink-300 decoration-8 underline-offset-8">æ–°å¢æ”¯å‡º ğŸ’œ</h3>
                <select 
                  value={newExpense.payer} 
                  onChange={(e) => setNewExpense({...newExpense, payer: e.target.value})}
                  className="bg-purple-100 rounded-[25px] px-8 py-4 font-black text-lg text-[#9D76C1] border-none shadow-inner outline-none"
                >
                  {members.map(m => <option key={m}>{m}</option>)}
                </select>
              </div>
              <div className="space-y-8">
                <input 
                  type="date" 
                  value={newExpense.date}
                  onChange={(e) => setNewExpense({...newExpense, date: e.target.value})}
                  className="w-full border-b-6 border-purple-50 pb-5 text-2xl font-black focus:border-purple-400 outline-none bg-transparent" 
                />
                <input 
                  placeholder="è²·äº†ä»€éº¼ï¼Ÿ" 
                  value={newExpense.item}
                  onChange={(e) => setNewExpense({...newExpense, item: e.target.value})}
                  className="w-full border-b-6 border-purple-50 pb-5 text-2xl font-black focus:border-purple-400 outline-none" 
                />
                <div className="grid grid-cols-1 gap-8">
                  <input 
                    type="number" 
                    placeholder="æ—¥å¹£ Â¥" 
                    value={newExpense.amount}
                    onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                    className="w-full border-4 border-purple-50 p-6 text-3xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-[30px]" 
                  />
                </div>
              </div>
              <button 
                onClick={addExpense} 
                disabled={isSaving}
                className="w-full kuromi-gradient text-white py-8 rounded-[50px] font-black text-2xl shadow-2xl flex items-center justify-center gap-4 active:scale-95 disabled:grayscale"
              >
                {isSaving ? <RefreshCw className="animate-spin w-8 h-8" /> : 'ç´€éŒ„é›²ç«¯ ğŸ’œ'}
              </button>
            </div>

            {/* æ”¯å‡ºæ¸…å–® */}
            <div className="space-y-8 pb-20">
              <h3 className="text-3xl font-black text-slate-800 flex items-center gap-4 px-4">
                <Banknote className="w-10 h-10 text-purple-400" /> é›²ç«¯å¸³æœ¬
              </h3>
              {expenses.map(ex => (
                <div key={ex.id} className="bg-white rounded-[45px] border-4 border-[#E2D9F3] p-10 flex flex-col shadow-2xl border-l-[25px] border-l-[#9D76C1]">
                  <div className="flex justify-between items-center">
                    <div className="flex-1 mr-8">
                      <div className="flex items-center gap-4 mb-3">
                        <span className="text-sm font-black text-white bg-slate-800 px-4 py-1.5 rounded-xl">{ex.date}</span>
                        <span className="text-md text-slate-400 font-black uppercase tracking-widest">{ex.payer}</span>
                      </div>
                      <p className="text-3xl font-black text-slate-700">{ex.item}</p>
                    </div>
                    <div className="text-right flex items-center gap-6">
                      <div>
                        <p className="text-4xl font-black text-slate-800">Â¥{ex.amount.toLocaleString()}</p>
                        <p className="text-md font-black text-pink-400">NT${ex.amountTwd.toLocaleString()}</p>
                      </div>
                      <button onClick={() => deleteExpense(ex.id)} className="p-5 bg-red-50 text-red-400 rounded-full active:scale-90"><Trash2 className="w-8 h-8" /></button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* (3) å·¥å…·åˆ†é  */}
        {activeTab === 'tools' && (
          <div className="space-y-16 animate-in fade-in duration-500">
            <section className="bg-white rounded-[50px] border-[10px] border-[#9D76C1] p-12 shadow-2xl relative">
              <div className="absolute -right-8 -top-8 animate-bounce text-purple-200"><Hotel className="w-20 h-20" /></div>
              <h3 className="text-4xl font-black mb-3 text-[#2D2727]">åšå¤šè¥¿éµ CROOM</h3>
              <p className="text-md text-slate-400 mb-10 font-black uppercase tracking-[0.2em]">æ«›ç”°ç¥ç¤¾å‰ç«™ 4 è™Ÿå‡ºå£å°é¢</p>
              <div className="flex gap-6">
                <button onClick={() => openMap('åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—')} className="flex-1 kuromi-gradient text-white py-7 rounded-[40px] font-black text-xl shadow-2xl">åœ°åœ– ğŸ“</button>
                <a href="tel:092-235-0311" className="flex-1 border-6 border-[#2D2727] text-center py-7 rounded-[40px] font-black text-xl flex items-center justify-center">æ’¥æ‰“ ğŸ“</a>
              </div>
            </section>
            
            <section>
              <h3 className="text-4xl font-black text-slate-800 mb-10 px-4 flex items-center gap-4">
                <Luggage className="text-pink-400 w-14 h-14" /> æ—…è¡Œç‹€æ…‹
              </h3>
              <div className="bg-slate-100 p-10 rounded-[50px] border-4 border-dashed border-slate-300">
                <p className="font-black text-slate-500 text-center">é›²ç«¯åŒæ­¥åŠŸèƒ½æ­£å¸¸é‹ä½œä¸­ ğŸ’œ</p>
                <p className="text-xs text-slate-400 text-center mt-2 tracking-widest font-bold">DEVICE ID: {user?.uid?.substring(0, 8)}</p>
              </div>
            </section>
          </div>
        )}
      </div>

      {/* ç·¨è¼¯è¡Œç¨‹å½ˆçª— */}
      {isEditingPlan && (
        <div className="fixed inset-0 z-[110] modal-mask flex items-center justify-center p-8">
          <div className="bg-white w-full rounded-[60px] p-12 shadow-2xl space-y-10 border-[10px] border-purple-100 animate-in zoom-in duration-300">
            <h3 className="text-4xl font-black text-slate-800 flex items-center gap-4">
              <PencilLine className="text-purple-500 w-10 h-10" /> {editingPlan ? 'ä¿®æ”¹è¨ˆç•«' : 'æ–°å¢è¨ˆç•«'}
            </h3>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-black text-slate-400 uppercase ml-4 tracking-[0.2em]">æŠµé”æ™‚é–“</label>
                <input 
                  value={editPlanBuffer.time} 
                  onChange={(e) => setEditPlanBuffer({...editPlanBuffer, time: e.target.value})}
                  placeholder="ä¾‹å¦‚ 14:30" 
                  className="w-full border-4 border-purple-50 p-5 text-3xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-[30px] mt-2" 
                />
              </div>
              <div>
                <label className="text-sm font-black text-slate-400 uppercase ml-4 tracking-[0.2em]">å…§å®¹èªªæ˜</label>
                <input 
                  value={editPlanBuffer.title} 
                  onChange={(e) => setEditPlanBuffer({...editPlanBuffer, title: e.target.value})}
                  placeholder="è¦å»å“ªè£¡å‘¢ï¼Ÿ" 
                  className="w-full border-4 border-purple-50 p-5 text-3xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-[30px] mt-2" 
                />
              </div>
            </div>
            <div className="flex gap-4 pt-6">
              <button 
                onClick={savePlan} 
                disabled={isSaving}
                className="flex-1 kuromi-gradient text-white py-8 rounded-[40px] font-black text-2xl shadow-2xl flex items-center justify-center gap-4 active:scale-95"
              >
                {isSaving ? <RefreshCw className="animate-spin w-8 h-8" /> : 'å„²å­˜ ğŸ’œ'}
              </button>
              <button onClick={() => setIsEditingPlan(false)} className="px-10 bg-slate-100 text-slate-400 rounded-[40px] font-black text-xl">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      )}

      {/* è£é£¾åº•éƒ¨ */}
      <div className="fixed bottom-0 left-0 right-0 h-8 kuromi-gradient z-[60]" />
    </div>
  );
};

export default App;
