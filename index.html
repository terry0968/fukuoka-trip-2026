<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡ 2026 | Kuromi å®¶æ—å¤§å†’éšª</title>

    <!-- æ ¸å¿ƒåº«å¼•å…¥ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (ç›¸å®¹ç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        
        :root {
            --kuromi-purple: #9D76C1;
            --kuromi-dark: #2D2727;
            --kuromi-pink: #FF91C1;
            --kuromi-bg: #F9F7FC;
            --restaurant-orange: #FFB085;
            --attraction-blue: #85A5FF;
        }

        body { 
            font-family: 'ZCOOL KuaiLe', cursive; 
            background-color: var(--kuromi-bg); 
            color: var(--kuromi-dark);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            font-size: 16px;
        }

        .kuromi-gradient { background: linear-gradient(135deg, #9D76C1 0%, #765898 100%); }
        .bg-pattern { 
            background-image: radial-gradient(var(--kuromi-purple) 0.5px, transparent 0.5px); 
            background-size: 20px 20px; 
        }

        .kuromi-card { 
            background: white; 
            border-radius: 30px; 
            border: 3px solid #E2D9F3; 
            box-shadow: 0 4px 12px rgba(157, 118, 193, 0.08);
            transition: all 0.2s ease;
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom { animation: spin-slow 1s linear infinite; }
        
        button { user-select: none; cursor: pointer; }

        .packing-item-done { 
            background-color: #F3F0F8 !important; 
            border-color: #D1C4E9 !important;
            opacity: 0.7;
            transform: scale(0.98);
        }
        .packing-text-done { 
            text-decoration: line-through; 
            color: #BDB7C4 !important;
        }

        .modal-mask {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .tab-active { color: #9D76C1; border-bottom: 4px solid #9D76C1; }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .nav-btn { font-size: 1.25rem; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: floating 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-pattern">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCAb0qAoOh0A88-wuRz-Gk_cU5f2vIOd3c",
            authDomain: "fukuoka-2026.firebaseapp.com",
            projectId: "fukuoka-2026",
            storageBucket: "fukuoka-2026.firebasestorage.app",
            messagingSenderId: "545717934606",
            appId: "1:545717934606:web:0d6ba3dd86addc76a77a5f"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "fukuoka-2026";
        const apiKey = ""; // API key provided by environment

        // ğŸ› ï¸ å®šç¾©å›ºå®šè¡Œç¨‹é‡é»
        const DEFAULT_PLANS = {
            '5/30': [
                { time: '14:40', title: 'æŠµé”ç¦å²¡ (CI128) âœˆï¸', type: 'fixed' },
                { time: '19:00', title: 'é£¯åº— Check-in ğŸ¨', type: 'attraction' },
                { time: '20:30', title: 'åšå¤šé‹æ²³åŸ ğŸ›ï¸', type: 'attraction' }
            ],
            '5/31': [
                { time: '10:00', title: 'å¤§æ¿ å…¬åœ’æ•£æ­¥ ğŸŒ³', type: 'attraction' },
                { time: '14:30', title: 'TeamLab Forest ğŸ¨', type: 'attraction' }
            ],
            '6/1': [
                { time: '10:00', title: 'å¤ªå®°åºœå¤©æ»¿å®® ğŸŒ¸', type: 'attraction' },
                { time: '14:00', title: 'ä¹å·åœ‹ç«‹åšç‰©é¤¨ ğŸº', type: 'attraction' }
            ],
            '6/2': [
                { time: '11:00', title: 'LaLaport ç¦å²¡ (1:1 é‹¼å½ˆ) ğŸ¤–', type: 'attraction' }
            ],
            '6/3': [
                { time: '08:30', title: 'ç”±å¸ƒé™¢ä¸€æ—¥éŠ (é‡‘é±—æ¹–ã€æ¹¯ä¹‹åª) â™¨ï¸', type: 'attraction' }
            ],
            '6/4': [
                { time: '10:00', title: 'æµ·ä¹‹ä¸­é“æµ·æ´‹ä¸–ç•Œ (æ°´æ—é¤¨) ğŸ¬', type: 'attraction' }
            ],
            '6/5': [
                { time: '10:30', title: 'å¤©ç¥é€›è¡—ä¸€æ—¥éŠ ğŸ›ï¸', type: 'attraction' }
            ],
            '6/6': [
                { time: '09:30', title: 'æ«›ç”°ç¥ç¤¾åƒæ‹œ â›©ï¸', type: 'attraction' },
                { time: '11:00', title: 'å·ç«¯é€šå•†åº—è¡— ğŸ¡', type: 'attraction' },
                { time: '16:00', title: 'å‰å¾€ç¦å²¡æ©Ÿå ´ (CI129) âœˆï¸', type: 'fixed' }
            ]
        };

        const Icon = ({ name, className = "", size = 24 }) => {
            const icons = {
                'heart': "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.505 4.04 3 5.5L12 21l7-7Z",
                'coins': "M11 15h2M12 12V3c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v1h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V6c0-1.1.9-2 2-2h1V3c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v9Z",
                'check-circle': "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3",
                'trash': "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",
                'refresh': "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5",
                'hotel': "M3 21V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12M7 11h2M7 15h2M15 11h2M15 15h2M11 21v-4a1 1 0 0 1 1-1h0a1 1 0 0 1 1 1v4",
                'luggage': "M3 14h18M7 21h10M3 7h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zM7 7V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v3",
                'check': "M20 6L9 17l-5-5",
                'plus': "M12 5v14M5 12h14",
                'pencil': "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z",
                'chevron-left': "M15 18l-6-6 6-6",
                'chevron-down': "M6 9l6 6 6-6",
                'chevron-right': "M9 18l6-6-6-6",
                'navigation': "M3 11l19-9-9 19-2-8-8-2z",
                'alert': "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01",
                'sparkles': "M12 3l1.912 5.886L21 10.8l-5.176 3.914L17.738 21 12 17.114 6.262 21l1.914-6.286L3 10.8l7.088-1.914L12 3z",
                'phone': "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",
                'map-pinned': "M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",
                'utensils': "M3 2v7c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",
                'plane': "M22 16.21v-1.89L14.84 9.9 14.84 4a1.5 1.5 0 0 0-3 0v5.9L4.67 14.32v1.89l7.17-2.73v5.13l-1.71 1.14v1.33l3.37-1.01 3.37 1.01v-1.33l-1.71-1.14v-5.13L22 16.21z",
                'languages': "M5 8l6 6M4 14l6-6M2 5h12M7 2h1M22 22l-5-10-5 10M14 18h6",
                'sun': "M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z M12 1v2 M12 21v2 M4.22 4.22l1.42 1.42 M18.36 18.36l1.42 1.42 M1 12h2 M21 12h2 M4.22 19.78l1.42-1.42 M18.36 5.64l1.42-1.42",
                'cloud': "M17.5 19a5.5 5.5 0 0 0 0-11 1.5 1.5 0 0 0-1.5 1.5A7 7 0 1 0 5 15.5 5.5 5.5 0 0 0 10.5 21h7",
                'cloud-rain': "M16 13v8 M8 13v8 M12 15v8 M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25",
                'volume': "M11 5L6 9H2v6h4l5 4V5z M19.07 4.93a10 10 0 0 1 0 14.14 M15.54 8.46a5 5 0 0 1 0 7.07",
                'shopping': "M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6zm-2 4h16M16 10a4 4 0 0 1-8 0",
                'x': "M18 6L6 18M6 6l12 12"
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={`${className} pointer-events-none transition-all`}>
                    <path d={icons[name] || ""} />
                </svg>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [expenses, setExpenses] = useState([]);
            const [itineraryData, setItineraryData] = useState([]);
            const [packingItems, setPackingItems] = useState({});
            const [activeTab, setActiveTab] = useState('itinerary'); 
            const [itineraryView, setItineraryView] = useState('list');
            const [selectedDayIdx, setSelectedDayIdx] = useState(0);
            const [fxJpy, setFxJpy] = useState('');
            const [fxTwd, setFxTwd] = useState('');
            const exchangeRate = 0.211;

            // ğŸ› ï¸ å¤©æ°£èˆ‡é å ±ç‹€æ…‹
            const [weather, setWeather] = useState({ temp: '--', code: 0, loading: true });
            const [forecast, setForecast] = useState([]);
            const [isWeatherModalOpen, setIsWeatherModalOpen] = useState(false);
            const [speakingId, setSpeakingId] = useState(null);

            const [expandedCats, setExpandedCats] = useState({
                'ä¸€ã€è­‰ä»¶èˆ‡é‡‘éŒ¢': true, 'äºŒã€Ruby å¯¶å¯¶å°ˆå€': true, 'ä¸‰ã€è¡£ç‰©é…ä»¶': true,
                'å››ã€3C æ•¸ä½ç”¢å“': true, 'äº”ã€è—¥å“èˆ‡ä¿å¥': true, 'å…­ã€ç›¥æ´—èˆ‡æ¸…æ½”': true,
                'ç”Ÿå­˜æ—¥èªå°æ‰‹å†Š': true
            });

            const mapSpotList = [
                { category: 'ç†±é–€æ™¯é» â›©ï¸', items: ['åšå¤šé‹æ²³åŸ', 'æ«›ç”°ç¥ç¤¾', 'å¤ªå®°åºœå¤©æ»¿å®®', 'ç¦å²¡åŸè·¡/å¤§æ¿ å…¬åœ’', 'ç¦å²¡å¡”', 'LaLaport ç¦å²¡ (é‹¼å½ˆ)', 'æµ·ä¹‹ä¸­é“æµ·æ¿±å…¬åœ’'] },
                { category: 'å¿…é€›å•†å ´/è—¥å¦ ğŸ›ï¸', items: ['å¤©ç¥åœ°ä¸‹è¡—', 'å”å‰è¨¶å¾· ä¸­æ´²åº—', 'å¤§åœ‹è—¥å¦', 'æ°¸æ—ºå¤¢æ¨‚åŸAEON', 'åšå¤šè»Šç«™é˜ªæ€¥'] },
                { category: 'å®¶æ—ç¾é£Ÿ ğŸ¥©', items: ['ç‡’è‚‰ å¤§æ±åœ’', 'ä¸€è˜­æ‹‰éºµ ç¸½åº—', 'åšå¤šè¯å‘³é³¥ (æ°´ç‚Šé‹)', 'å…ƒç¥–åšå¤šæ˜å¤ªå­é£¯', 'åšå¤šç‰›é›œé‹ ãŠãŠã‚„ã¾', 'bills ç¦å²¡ (é¬†é¤…)'] }
            ];

            const survivalPhrases = [
                { id: 'ph1', jp: 'ã‚ã‚ŠãŒã¨ã†', ro: 'Arigatou', tw: 'è¬è¬' },
                { id: 'ph2', jp: 'ã™ã¿ã¾ã›ã‚“', ro: 'Sumimasen', tw: 'ä¸å¥½æ„æ€ / è«‹å•' },
                { id: 'ph3', jp: 'ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', ro: 'Ikura desu ka?', tw: 'å¤šå°‘éŒ¢ï¼Ÿ' },
                { id: 'ph4', jp: 'ã“ã‚Œã‚’ãã ã•ã„', ro: 'Kore o kudasai', tw: 'è«‹çµ¦æˆ‘é€™å€‹' },
                { id: 'ph5', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', ro: 'Toire wa doko desu ka?', tw: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ' },
                { id: 'ph6', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', ro: 'Okaikei o onegaishimasu', tw: 'è«‹å¹«æˆ‘çµå¸³' }
            ];

            const [newExpense, setNewExpense] = useState({ 
                date: new Date().toISOString().split('T')[0], payer: 'KCY', item: '', amount: '' 
            });

            const [isEditingPlan, setIsEditingPlan] = useState(false);
            const [editingPlan, setEditingPlan] = useState(null);
            const [editPlanBuffer, setEditPlanBuffer] = useState({ time: '', title: '', type: 'attraction' });

            const [isSaving, setIsSaving] = useState(false);
            const [toast, setToast] = useState({ show: false, msg: '' });

            const members = ['KCY', 'Ruby', 'YSL', 'Tsai'];
            const dates = [
                { date: '5/30', dayName: 'SAT' }, { date: '5/31', dayName: 'SUN' },
                { date: '6/1', dayName: 'MON' }, { date: '6/2', dayName: 'TUE' },
                { date: '6/3', dayName: 'WED' }, { date: '6/4', dayName: 'THU' },
                { date: '6/5', dayName: 'FRI' }, { date: '6/6', dayName: 'SAT' }
            ];

            const packingListTemplate = [
                { category: 'ä¸€ã€è­‰ä»¶èˆ‡é‡‘éŒ¢', items: ['è­·ç…§ (æ­£æœ¬+å½±æœ¬)', 'Visit Japan Web QR Code', 'æ—¥å¹£ç¾é‡‘', 'ä¿¡ç”¨å¡/æ‚ éŠå¡', 'æ—…éŠä¿éšªè­‰æ˜æ›¸'] },
                { category: 'äºŒã€Ruby å¯¶å¯¶å°ˆå€', items: ['è¶³é‡å°¿å¸ƒ & æ¿•ç´™å·¾', 'å¥¶ç²‰åˆ†è£åŒ… & å¥¶ç“¶', 'å‰¯é£Ÿå“ & å¯¶å¯¶é›¶é£Ÿ', 'å¯¶å¯¶é¤å…· & åœå…œ', 'æ‰‹æ¨è»Š & é˜²é›¨ç½©', 'å°æ¯¯å­ & æ›æ´—è¡£ç‰©'] },
                { category: 'ä¸‰ã€è¡£ç‰©é…ä»¶', items: ['æ›æ´—è¡£ç‰© (3-4å¥—)', 'å…§è¡£è¤² & è¥ªå­', 'èˆ’é©å¥½èµ°çš„é‹', 'è¼•ä¾¿å¤–å¥— (è–„)', 'æ‘ºç–Šé›¨å‚˜ & è¼•ä¾¿é›¨è¡£', 'å¸½å­ & å¤ªé™½çœ¼é¡'] },
                { category: 'å››ã€3C æ•¸ä½ç”¢å“', items: ['æ‰‹æ©Ÿ & è¡Œå‹•é›»æº', 'å……é›»ç·š & å……é›»é ­', 'WiFiæ©Ÿ/ç¶²å¡', 'é™å™ªè€³æ©Ÿ', 'ç›¸æ©Ÿ & è¨˜æ†¶å¡'] },
                { category: 'äº”ã€è—¥å“èˆ‡ä¿å¥', items: ['å€‹äººè™•æ–¹è—¥', 'å¸¸å‚™æ„Ÿå†’/è…¸èƒƒè—¥', 'é€€ç‡’è—¥/æ­¢ç—›è—¥', 'é˜²èšŠæ¶² & æ­¢ç™¢è—¥è†', 'OKç¹ƒ & é…’ç²¾æ£‰ç‰‡'] },
                { category: 'å…­ã€ç›¥æ´—èˆ‡æ¸…æ½”', items: ['ç‰™åˆ· & ç‰™è†', 'æ´—é¢ä¹³ & è­·è†šå“', 'ä¹¾æ´—æ‰‹ & å£ç½©', 'è¡›ç”Ÿç´™ & ç”Ÿç†ç”¨å“'] }
            ];

            const countdownDays = useMemo(() => {
                const target = new Date('2026-05-30T00:00:00');
                const now = new Date();
                const diff = target.getTime() - now.getTime();
                return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
            }, []);

            // ğŸ•’ ç²å–ç¦å²¡å¤©æ°£ (å« 7 å¤©é å ±æ•¸æ“š)
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5902&longitude=130.4017&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        
                        setWeather({
                            temp: Math.round(data.current_weather.temperature),
                            code: data.current_weather.weathercode,
                            loading: false
                        });

                        // æ•´ç† 7 å¤©é å ±æ¸…å–®
                        const forecastList = data.daily.time.map((t, idx) => ({
                            date: t.split('-').slice(1).join('/'), // è½‰ç‚º MM/DD
                            max: Math.round(data.daily.temperature_2m_max[idx]),
                            min: Math.round(data.daily.temperature_2m_min[idx]),
                            code: data.daily.weathercode[idx]
                        }));
                        setForecast(forecastList);

                    } catch (e) {
                        setWeather(prev => ({ ...prev, loading: false }));
                    }
                };
                fetchWeather();
                const timer = setInterval(fetchWeather, 600000); 
                return () => clearInterval(timer);
            }, []);

            const getWeatherIcon = (code) => {
                if (code <= 3) return 'sun'; 
                if (code <= 67) return 'cloud'; 
                if (code >= 71) return 'cloud-rain'; 
                return 'sun';
            };

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) setUser(u);
                    else auth.signInAnonymously().catch(e => console.error(e));
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const pathBase = `artifacts/${appId}/public/data`;
                const unsubExp = db.collection(`${pathBase}/expenses`).onSnapshot(snap => {
                    setExpenses(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.date||"").localeCompare(a.date||"")));
                });
                const unsubItin = db.collection(`${pathBase}/itinerary`).onSnapshot(snap => {
                    setItineraryData(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubExp(); unsubItin(); };
            }, [user]);

            const currentDayPlans = useMemo(() => {
                const day = dates[selectedDayIdx];
                if (!day) return [];
                const target = day.date;
                
                const timeToMinutes = (t) => {
                    if (!t) return 9999;
                    const digits = t.match(/\d+/g);
                    if (!digits || digits.length === 0) return 9999;
                    return parseInt(digits[0], 10) * 60 + (digits.length > 1 ? parseInt(digits[1], 10) : 0);
                };

                const cloudPlans = (itineraryData || []).filter(p => p && p.targetDate === target);
                const cloudIds = new Set(cloudPlans.map(p => p.id));

                const staticPlans = (DEFAULT_PLANS[target] || [])
                    .map(p => ({ 
                        ...p, 
                        id: `static-${target.replace('/', '-')}-${p.time.replace(':', '-')}`, 
                        isStatic: true 
                    }))
                    .filter(p => !cloudIds.has(p.id));

                return [...cloudPlans, ...staticPlans].sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            }, [itineraryData, selectedDayIdx]);

            const speakPhrase = async (phrase) => {
                if (speakingId) return;
                setSpeakingId(phrase.id);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Say clearly in Japanese: ${phrase.jp}` }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                            model: "gemini-2.5-flash-preview-tts"
                        })
                    });
                    const result = await response.json();
                    const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (audioData) {
                        const binaryString = window.atob(audioData);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
                        const sampleRate = 24000;
                        const wavHeader = new ArrayBuffer(44);
                        const view = new DataView(wavHeader);
                        view.setUint32(0, 0x52494646, false); 
                        view.setUint32(4, 36 + len, true);
                        view.setUint32(8, 0x57415645, false); 
                        view.setUint32(12, 0x666d7420, false); 
                        view.setUint32(16, 16, true);
                        view.setUint16(20, 1, true); 
                        view.setUint16(22, 1, true); 
                        view.setUint32(24, sampleRate, true);
                        view.setUint32(28, sampleRate * 2, true);
                        view.setUint16(32, 2, true);
                        view.setUint16(34, 16, true);
                        view.setUint32(36, 0x64617461, false); 
                        view.setUint32(40, len, true);
                        const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        const audio = new Audio(url);
                        audio.onended = () => { setSpeakingId(null); URL.revokeObjectURL(url); };
                        audio.play();
                    } else { setSpeakingId(null); }
                } catch (e) { setSpeakingId(null); }
            };

            const handleJpyChange = (v) => { setFxJpy(v); setFxTwd(v === '' ? '' : Math.round(parseFloat(v) * exchangeRate).toString()); };
            const handleTwdChange = (v) => { setFxTwd(v); setFxJpy(v === '' ? '' : Math.round(parseFloat(v) / exchangeRate).toString()); };
            const showToast = (msg) => { setToast({ show: true, msg }); setTimeout(() => setToast({ show: false, msg: '' }), 3000); };
            const openMap = (q) => { const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`; window.open(url, '_blank'); };

            const addExpense = async () => {
                if (!newExpense.item.trim() || isNaN(parseFloat(newExpense.amount)) || !user) return;
                setIsSaving(true);
                try {
                    await db.collection(`artifacts/${appId}/public/data/expenses`).add({
                        ...newExpense, amount: parseFloat(newExpense.amount), amountTwd: Math.round(parseFloat(newExpense.amount) * exchangeRate), createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setNewExpense(prev => ({ ...prev, item: '', amount: '' }));
                    showToast("å·²å­˜å…¥é›²ç«¯ ğŸ’œ");
                } finally { setIsSaving(false); }
            };

            const openEditModal = (e, plan) => { e.preventDefault(); e.stopPropagation(); setEditingPlan(plan); setEditPlanBuffer({ time: plan.time || '', title: plan.title || '', type: plan.type || 'attraction' }); setIsEditingPlan(true); };

            const savePlan = async () => {
                if (!editPlanBuffer.time || !editPlanBuffer.title || !user) return;
                setIsSaving(true);
                try {
                    const safeId = editingPlan ? editingPlan.id : `plan-${Date.now()}`;
                    await db.collection(`artifacts/${appId}/public/data/itinerary`).doc(safeId).set({ 
                        ...editPlanBuffer, 
                        targetDate: dates[selectedDayIdx].date, 
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                    }, { merge: true });
                    setIsEditingPlan(false); 
                    setEditingPlan(null); 
                    showToast("è¡Œç¨‹åŒæ­¥æˆåŠŸ ğŸ’œ");
                } catch(e) { alert("å„²å­˜å¤±æ•— ğŸ’œ"); } finally { setIsSaving(false); }
            };

            const deletePlan = async (e, id) => {
                e.preventDefault(); e.stopPropagation();
                if (!window.confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                await db.collection(`artifacts/${appId}/public/data/itinerary`).doc(id).delete();
                showToast("è¡Œç¨‹å·²ç§»é™¤");
            };

            const toggleCategory = (catName) => { setExpandedCats(prev => ({ ...prev, [catName]: !prev[catName] })); };

            return (
                <div className="max-w-md mx-auto min-h-screen relative pb-20">
                    {/* Toast */}
                    <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[200] transition-all duration-500 ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-10 pointer-events-none'}`}>
                        <div className="bg-black/90 text-white px-6 py-3 rounded-full flex items-center gap-2 shadow-xl border border-purple-400 backdrop-blur-md text-sm text-center">
                            <Icon name="check-circle" size={18} className="text-pink-400" />
                            <span className="font-bold">{toast.msg}</span>
                        </div>
                    </div>

                    <header className="kuromi-gradient text-white p-6 pt-10 rounded-b-[40px] shadow-lg relative overflow-hidden">
                        <div className="flex justify-between items-start relative z-10">
                            <div>
                                <h1 className="text-5xl font-bold tracking-tighter" style={{ textShadow: '2px 2px 0px rgba(0,0,0,0.2)' }}>ç¦å²¡ 2026</h1>
                                <div className="flex items-center gap-2 mt-2">
                                    <span className="bg-black/30 px-3 py-1 rounded-full text-[10px] uppercase tracking-widest font-bold">SHEN FAMILY TRIP</span>
                                    <Icon name="heart" size={14} className="fill-pink-400 text-pink-400 animate-pulse" />
                                </div>
                            </div>
                            
                            {/* ğŸ› ï¸ é»æ“Šå¤©æ°£å°å¡é–‹å•Ÿé å ± */}
                            <div 
                                onClick={() => setIsWeatherModalOpen(true)}
                                className="bg-black/30 p-3 rounded-[25px] backdrop-blur-md border border-white/10 text-center min-w-[90px] float-anim cursor-pointer active:scale-90 transition-all"
                            >
                                <Icon name={getWeatherIcon(weather.code)} size={32} className={`${weather.loading ? 'animate-spin' : ''} text-pink-200 mx-auto mb-1`} />
                                <p className="text-2xl font-black">{weather.temp}Â°C</p>
                                <p className="text-[9px] opacity-70 font-bold uppercase tracking-widest">Fukuoka</p>
                            </div>
                        </div>
                        <div className="bg-white/20 px-4 py-2 rounded-2xl backdrop-blur-sm border border-white/10 mt-6 flex items-center justify-center gap-2">
                            <Icon name="sparkles" size={14} className="text-yellow-200" />
                            <span className="text-sm font-black tracking-widest">è·é›¢å‡ºç™¼é‚„æœ‰ <span className="text-pink-200 text-xl">{countdownDays}</span> å¤©</span>
                        </div>
                    </header>

                    <nav className="flex bg-white/95 backdrop-blur-lg sticky top-0 z-50 px-2 border-b-4 border-purple-50 shadow-sm overflow-x-auto hide-scrollbar">
                        <button onClick={() => { setActiveTab('itinerary'); setItineraryView('list'); }} className={`flex-1 min-w-[80px] py-6 font-black nav-btn transition-all ${activeTab === 'itinerary' ? 'tab-active' : 'text-slate-400'}`}>è¡Œç¨‹</button>
                        <button onClick={() => setActiveTab('map')} className={`flex-1 min-w-[80px] py-6 font-black nav-btn transition-all ${activeTab === 'map' ? 'tab-active' : 'text-slate-400'}`}>åœ°åœ–</button>
                        <button onClick={() => setActiveTab('expense')} className={`flex-1 min-w-[80px] py-6 font-black nav-btn transition-all ${activeTab === 'expense' ? 'tab-active' : 'text-slate-400'}`}>è¨˜å¸³</button>
                        <button onClick={() => setActiveTab('tools')} className={`flex-1 min-w-[80px] py-6 font-black nav-btn transition-all ${activeTab === 'tools' ? 'tab-active' : 'text-slate-400'}`}>å·¥å…·</button>
                    </nav>

                    <div className="px-5 py-6">
                        {/* 1. è¡Œç¨‹å€åŸŸ */}
                        {activeTab === 'itinerary' && (
                            itineraryView === 'list' ? (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-2xl font-black text-slate-800 px-1 flex justify-between items-center uppercase italic underline decoration-pink-300 decoration-4">å†’éšªè¨ˆç•«è¡¨ ğŸ’œ</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        {dates.map((day, idx) => (
                                            <div key={day.date} onClick={() => { setSelectedDayIdx(idx); setItineraryView('detail'); }} 
                                                 className="kuromi-card p-6 flex flex-col items-center justify-center text-center relative active:scale-95 border-b-[8px] border-b-[#9D76C1]">
                                                <span className="text-[10px] font-black text-purple-300 uppercase mb-1">{day.dayName}</span>
                                                <span className="text-5xl font-black text-slate-700 mb-2">{day.date.split('/')[1]}</span>
                                                <span className="text-[10px] font-black text-white bg-purple-400 px-3 py-1 rounded-full">{day.date}</span>
                                                {(itineraryData && itineraryData.some(p => p && p.targetDate === day.date)) || DEFAULT_PLANS[day.date] ? (
                                                    <div className="absolute top-4 right-4 w-3 h-3 bg-pink-400 rounded-full animate-pulse border-2 border-white shadow-sm" />
                                                ) : null}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-in slide-in-from-bottom">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setItineraryView('list')} className="p-3 bg-white rounded-full shadow text-purple-600 active:scale-75 border border-purple-50"><Icon name="chevron-left" size={20} /></button>
                                        <div><h2 className="text-3xl font-black text-slate-800">{dates[selectedDayIdx]?.date}</h2><p className="text-[10px] font-black text-purple-400 uppercase tracking-widest">æœ¬æ—¥è¦åŠƒè©³æƒ…</p></div>
                                    </div>
                                    <button onClick={() => { setEditingPlan(null); setEditPlanBuffer({time:'', title:'', type: 'attraction'}); setIsEditingPlan(true); }} className="w-full bg-white border-2 border-dashed border-purple-200 text-purple-500 py-6 rounded-[30px] flex items-center justify-center gap-2 active:scale-95 shadow-inner"><Icon name="plus" size={20} /><span className="font-black text-2xl">è‡ªå®šç¾©è¨ˆç•«</span></button>
                                    <div className="space-y-4">
                                        {currentDayPlans.map(plan => {
                                            let cardBorderColor = 'border-l-[#9D76C1]';
                                            let timeBgColor = 'bg-slate-800';
                                            let typeLabel = '';
                                            if (plan.isStatic || plan.type === 'fixed') { cardBorderColor = 'border-l-pink-400'; timeBgColor = 'bg-pink-400'; typeLabel = 'æ ¸å¿ƒé‡é»'; }
                                            else if (plan.type === 'restaurant') { cardBorderColor = 'border-l-orange-400'; timeBgColor = 'bg-orange-400'; typeLabel = 'ç¾å‘³é¤å»³'; }
                                            else { cardBorderColor = 'border-l-indigo-400'; timeBgColor = 'bg-indigo-400'; typeLabel = 'å†’éšªæ™¯é»'; }

                                            return (
                                                <div key={plan.id} className={`kuromi-card p-5 border-l-[15px] shadow-md ${cardBorderColor}`}>
                                                    <div className="flex justify-between items-center mb-4">
                                                        <div className="flex items-center gap-2">
                                                            <span className={`text-xs font-black text-white px-3 py-1 rounded-full ${timeBgColor}`}>{plan.time}</span>
                                                            <span className="text-[10px] font-black opacity-30 uppercase tracking-tighter">{typeLabel}</span>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <div onClick={(e) => openEditModal(e, plan)} className="w-10 h-10 flex items-center justify-center bg-purple-50 text-purple-400 rounded-full active:scale-75 border border-purple-100 z-20 cursor-pointer"><Icon name="pencil" size={20} /></div>
                                                            {!plan.isStatic && <div onClick={(e) => deletePlan(e, plan.id)} className="w-10 h-10 flex items-center justify-center bg-red-50 text-red-400 rounded-full active:scale-75 border border-red-100 z-20 cursor-pointer"><Icon name="trash" size={20} /></div>}
                                                        </div>
                                                    </div>
                                                    <h3 className="text-2xl font-black text-slate-700 leading-tight">{plan.title}</h3>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )
                        )}

                        {activeTab === 'map' && (
                            <div className="space-y-8 animate-in fade-in">
                                <h2 className="text-2xl font-black text-slate-800 px-1 flex items-center gap-3 italic underline decoration-pink-300 decoration-4 tracking-wider underline-offset-4">æ™¯é»/ç¾é£Ÿåœ°åœ– ğŸ—ºï¸</h2>
                                <div className="bg-white rounded-[40px] p-8 shadow-xl border-4 border-purple-50 space-y-6">
                                    <p className="text-lg font-black text-slate-600 leading-relaxed">é–‹å•Ÿ Google åœ°åœ–æŸ¥çœ‹è©³ç´°ä½ç½® ğŸ’œ</p>
                                    <button onClick={() => window.open('https://maps.app.goo.gl/pd5Mgn8orC6EG7dc6', '_blank')} className="w-full bg-[#2D2727] text-white py-8 rounded-[35px] flex items-center justify-center gap-4 shadow-2xl active:scale-95 border-4 border-purple-900/10">
                                        <Icon name="map-pinned" size={32} className="text-pink-400" />
                                        <div className="text-left"><span className="block font-black text-2xl tracking-wider">é–‹å•Ÿåœ°åœ–æ¸…å–®</span><span className="text-[10px] font-bold opacity-60 uppercase tracking-widest tracking-tighter">Google Maps List</span></div>
                                    </button>
                                </div>
                                <div className="space-y-8 pb-10">
                                    {mapSpotList.map((group, idx) => (
                                        <div key={idx} className="space-y-4">
                                            <h3 className="text-xl font-black text-[#8A63B3] px-4 flex items-center gap-2"><Icon name={idx === 0 ? "sparkles" : idx === 1 ? "shopping" : "utensils"} size={20} className="text-[#FF91C1]" />{group.category}</h3>
                                            <div className="grid grid-cols-1 gap-3 px-2">
                                                {group.items.map((item, i) => (
                                                    <div key={i} onClick={() => openMap(item)} className="kuromi-card p-5 flex items-center justify-between active:scale-95 transition-all shadow-sm border-2 border-purple-50 hover:bg-purple-50/30">
                                                        <span className="text-lg font-black text-slate-700">{item}</span>
                                                        <div className="p-3 bg-purple-50 rounded-2xl text-purple-400"><Icon name="navigation" size={18} /></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'expense' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-[#2D2727] text-white p-8 rounded-[40px] shadow-xl space-y-6">
                                    <p className="text-[10px] text-[#FF91C1] font-black uppercase tracking-[0.2em]">åŒ¯ç‡æ›ç®— 0.211</p>
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-4 border-b border-white/10 pb-3"><span className="text-2xl font-black opacity-30 w-8 text-center">Â¥</span><input type="number" value={fxJpy} onChange={(e) => handleJpyChange(e.target.value)} placeholder="0" className="flex-1 bg-transparent text-5xl font-black focus:outline-none placeholder:text-white/5" /></div>
                                        <div className="flex items-center gap-4 pt-2"><span className="text-2xl font-black text-[#FF91C1] w-8 text-center">$</span><input type="number" value={fxTwd} onChange={(e) => handleTwdChange(e.target.value)} placeholder="0" className="flex-1 bg-transparent text-5xl font-black text-[#FF91C1] focus:outline-none placeholder:text-pink-900/20" /></div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[40px] p-8 space-y-6 shadow-xl border-4 border-purple-50">
                                    <h3 className="text-xl font-black underline decoration-pink-300 decoration-4">æ–°å¢èŠ±è²» ğŸ’œ</h3>
                                    <div className="space-y-4"><div className="flex gap-4"><input type="date" value={newExpense.date} onChange={(e) => setNewExpense({...newExpense, date: e.target.value})} className="flex-1 border-b-2 border-purple-50 pb-2 text-sm font-black outline-none bg-transparent" /><select value={newExpense.payer} onChange={(e) => setNewExpense({...newExpense, payer: e.target.value})} className="bg-purple-50 rounded-full px-4 py-2 font-black text-xs text-[#9D76C1] outline-none">{members.map(m => <option key={m}>{m}</option>)}</select></div><input placeholder="è²·äº†ä»€éº¼ï¼Ÿ" value={newExpense.item} onChange={(e) => setNewExpense({...newExpense, item: e.target.value})} className="w-full border-b-2 border-purple-50 pb-2 text-sm font-black outline-none" /><input type="number" placeholder="é‡‘é¡ Â¥" value={newExpense.amount} onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})} className="w-full border-2 border-purple-50 p-4 text-xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-2xl" /></div>
                                    <button onClick={addExpense} disabled={isSaving} className="w-full kuromi-gradient text-white py-4 rounded-full font-black text-2xl shadow-lg flex items-center justify-center gap-2">{isSaving ? <Icon name="refresh" className="animate-spin-custom" size={18} /> : "ç´€éŒ„é–‹éŠ· ğŸ’œ"}</button>
                                </div>
                                {expenses.map(ex => (
                                    <div key={ex.id} className="kuromi-card p-5 flex justify-between items-center border-l-[12px] border-l-[#9D76C1] shadow-sm"><div className="flex-1 mr-2"><div className="flex items-center gap-2 mb-1"><span className="text-[9px] font-black text-white bg-slate-800 px-2 py-0.5 rounded-full">{ex.date}</span><span className="text-[9px] text-slate-400 font-black uppercase font-bold">{ex.payer}</span></div><p className="text-2xl font-black text-slate-700">{ex.item}</p></div><div className="text-right flex items-center gap-3"><div><p className="text-3xl font-black text-slate-800">Â¥{ex.amount?.toLocaleString()}</p><p className="text-[10px] font-black text-pink-400">NT${ex.amountTwd?.toLocaleString()}</p></div><button onClick={() => db.collection(`artifacts/${appId}/public/data/expenses`).doc(ex.id).delete()} className="p-2 bg-red-50 text-red-400 rounded-full border border-red-50"><Icon name="trash" size={14}/></button></div></div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'tools' && (
                            <div className="space-y-10 animate-in fade-in pb-10">
                                <section className="bg-white rounded-[40px] border-4 border-slate-800 p-8 shadow-xl relative overflow-hidden">
                                    <div className="absolute right-0 top-0 kuromi-gradient p-4 rounded-bl-3xl"><Icon name="plane" className="text-white" size={24} /></div>
                                    <h3 className="text-2xl font-black mb-6 text-slate-800 italic underline decoration-pink-300">èˆªç­è©³æƒ… âœˆï¸</h3>
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl">
                                            <div className="text-left"><p className="text-xs font-bold text-slate-400">5/30 å»ç¨‹ CI128</p><p className="text-lg font-black text-slate-800">14:40 - 18:05</p></div>
                                            <div className="text-right"><p className="text-xs font-bold text-slate-400">èˆªå»ˆ</p><p className="text-lg font-black text-pink-500">ç¬¬ä¸€èˆªå»ˆ</p></div>
                                        </div>
                                        <div className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl">
                                            <div className="text-left"><p className="text-xs font-bold text-slate-400">6/06 å›ç¨‹ CI129</p><p className="text-lg font-black text-slate-800">19:10 - 20:35</p></div>
                                            <div className="text-right"><p className="text-xs font-bold text-slate-400">èˆªå»ˆ</p><p className="text-lg font-black text-pink-500">åœ‹éš›ç·š</p></div>
                                        </div>
                                    </div>
                                </section>

                                <section className="bg-white rounded-[40px] border-4 border-[#9D76C1] p-8 shadow-xl text-center">
                                    <Icon name="hotel" size={40} className="text-purple-200 mx-auto mb-2 animate-bounce" />
                                    <h3 className="text-2xl font-black mb-1 text-[#2D2727]">åšå¤šè¥¿éµ CROOM</h3>
                                    <p className="text-[10px] text-slate-400 mb-6 font-bold tracking-widest uppercase">åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰ç«™</p>
                                    <div className="flex gap-4"><button onClick={() => window.open('https://www.google.com/maps/search/?api=1&query=åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—','_blank')} className="flex-1 kuromi-gradient text-white py-4 rounded-2xl font-black text-sm shadow-md">åœ°åœ–å®šä½</button><a href="tel:092-235-0311" className="flex-1 border-2 border-[#2D2727] text-center py-4 rounded-2xl font-black text-sm">æ’¥æ‰“é›»è©±</a></div>
                                </section>

                                <section>
                                    <div onClick={() => toggleCategory('ç”Ÿå­˜æ—¥èªå°æ‰‹å†Š')} className="flex items-center justify-between bg-white p-6 rounded-[30px] border-2 border-pink-100 shadow-sm active:bg-pink-50 cursor-pointer">
                                        <div className="flex items-center gap-3">
                                            <div className="p-3 bg-pink-100 rounded-2xl text-pink-400"><Icon name="languages" size={24} /></div>
                                            <p className="text-2xl font-black text-pink-500 tracking-wide">ç”Ÿå­˜æ—¥èªæ‰‹å†Š</p>
                                        </div>
                                        <Icon name={expandedCats['ç”Ÿå­˜æ—¥èªå°æ‰‹å†Š'] ? "chevron-down" : "chevron-right"} size={28} className="text-pink-300" />
                                    </div>
                                    {expandedCats['ç”Ÿå­˜æ—¥èªå°æ‰‹å†Š'] && (
                                        <div className="grid grid-cols-1 gap-4 mt-6 px-2 animate-in fade-in slide-in-from-top-2">
                                            {survivalPhrases.map((p, i) => (
                                                <div key={i} className="kuromi-card p-5 bg-white border-2 border-pink-50 flex justify-between items-center">
                                                    <div>
                                                        <p className="text-[10px] font-black text-pink-300 mb-1 uppercase tracking-widest">{p.tw}</p>
                                                        <p className="text-2xl font-black text-slate-700">{p.jp}</p>
                                                        <p className="text-sm font-bold text-slate-400 italic">[{p.ro}]</p>
                                                    </div>
                                                    <button onClick={() => speakPhrase(p)} className={`p-4 rounded-full transition-all active:scale-90 ${speakingId === p.id ? 'bg-pink-100 text-pink-500' : 'bg-purple-50 text-purple-400'}`}><Icon name={speakingId === p.id ? "refresh" : "volume"} size={24} className={speakingId === p.id ? 'animate-spin' : ''} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </section>

                                <section>
                                    <div className="flex items-center gap-3 mb-6 px-1"><div className="p-3 bg-pink-100 rounded-2xl text-[#FF91C1]"><Icon name="luggage" size={24} /></div><h3 className="text-2xl font-black text-slate-800 underline decoration-pink-300">è¡Œææ¸…å–® ğŸ’œ</h3></div>
                                    {packingListTemplate.map((cat, idx) => {
                                        const isExpanded = expandedCats[cat.category];
                                        return (
                                            <div key={idx} className="mb-6">
                                                <div onClick={() => toggleCategory(cat.category)} className="flex items-center justify-between bg-white p-5 rounded-[30px] border-2 border-purple-100 shadow-sm active:bg-purple-50 transition-all cursor-pointer"><p className="text-2xl font-black text-[#8A63B3] border-l-8 border-[#9D76C1] px-4 uppercase tracking-wide">{cat.category}</p><Icon name={isExpanded ? "chevron-down" : "chevron-right"} size={28} className="text-purple-300" /></div>
                                                {isExpanded && (<div className="space-y-3 px-2 mt-4 animate-in fade-in slide-in-from-top-2 duration-300">{cat.items.map(item => { const isDone = packingItems[item] === true; return (<div key={item} onClick={() => setPackingItems(prev => ({...prev, [item]:!prev[item]}))} className={`kuromi-card p-4 flex items-center gap-4 active:scale-95 ${isDone ? 'packing-item-done' : ''}`}><div className={`w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all ${isDone ? 'bg-[#9D76C1] border-transparent' : 'border-[#E2D9F3]'}`}>{isDone && <Icon name="check" className="text-white" size={16} />}</div><span className={`text-lg font-black text-slate-700 ${isDone ? 'packing-text-done' : ''}`}>{item}</span></div>);})}</div>)}
                                            </div>
                                        );
                                    })}
                                </section>
                                
                                <section className="bg-red-50 p-8 rounded-[40px] border-2 border-red-100">
                                    <h4 className="font-bold text-red-600 mb-4 flex items-center gap-2"><Icon name="alert" size={20} /> ç·Šæ€¥æ‡‰è®Š ğŸš¨</h4>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm"><div><p className="text-xs text-slate-400 font-bold uppercase">é§æ—¥ä»£è¡¨è™• (TECO)</p><p className="text-lg font-black text-slate-800">03-3280-7811</p></div><a href="tel:03-3280-7811" className="bg-red-500 text-white p-3 rounded-full active:scale-90"><Icon name="phone" size={18} /></a></div>
                                    </div>
                                </section>
                            </div>
                        )}
                    </div>

                    {/* ğŸ› ï¸ å¤©æ°£é å ±å½ˆçª— */}
                    {isWeatherModalOpen && (
                        <div className="fixed inset-0 z-[120] modal-mask flex items-center justify-center p-6">
                            <div className="bg-white w-full rounded-[45px] p-8 shadow-2xl space-y-6 border-[8px] border-purple-100 animate-in zoom-in duration-300 max-h-[80vh] overflow-y-auto hide-scrollbar">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-3xl font-black text-slate-800 italic underline decoration-pink-300 decoration-4">ç¦å²¡é€±å ± ğŸŒ¦ï¸</h3>
                                    <button onClick={() => setIsWeatherModalOpen(false)} className="p-3 bg-slate-100 rounded-full text-slate-400 active:scale-75 transition-all"><Icon name="x" size={20} /></button>
                                </div>
                                <div className="space-y-4">
                                    {forecast.length > 0 ? forecast.map((f, i) => (
                                        <div key={i} className="flex items-center justify-between bg-purple-50/50 p-5 rounded-3xl border-2 border-white shadow-sm">
                                            <div className="flex items-center gap-4">
                                                <span className="text-lg font-black text-slate-500 w-12">{f.date}</span>
                                                <Icon name={getWeatherIcon(f.code)} size={28} className="text-[#9D76C1]" />
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-xl font-black text-slate-700">{f.max}Â°</span>
                                                <div className="w-px h-6 bg-slate-200" />
                                                <span className="text-xl font-black text-slate-400">{f.min}Â°</span>
                                            </div>
                                        </div>
                                    )) : <p className="text-center py-10 opacity-30">è¼‰å…¥é å ±ä¸­...</p>}
                                </div>
                                <div className="pt-4">
                                    <button onClick={() => setIsWeatherModalOpen(false)} className="w-full kuromi-gradient text-white py-5 rounded-3xl font-black text-xl shadow-lg active:scale-95 transition-all">é—œé–‰ ğŸ’œ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ç·¨è¼¯å½ˆçª— */}
                    {isEditingPlan && (
                        <div className="fixed inset-0 z-[110] modal-mask flex items-center justify-center p-6">
                            <div className="bg-white w-full rounded-[40px] p-10 shadow-2xl space-y-8 border-8 border-purple-50 animate-in zoom-in">
                                <h3 className="text-3xl font-black text-slate-800 underline decoration-pink-300 decoration-4 underline-offset-4 text-center">{editingPlan ? 'ä¿®æ”¹è¨ˆç•« âœï¸' : 'æ–°å¢è¨ˆç•« âœï¸'}</h3>
                                <div className="space-y-6 text-left">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-2 block">å†’éšªé¡å‹</label>
                                        <div className="flex gap-2">
                                            <button onClick={() => setEditPlanBuffer({...editPlanBuffer, type: 'attraction'})} className={`flex-1 py-3 rounded-2xl font-black text-sm border-4 transition-all ${editPlanBuffer.type === 'attraction' ? 'border-[#9D76C1] bg-purple-50 text-[#9D76C1]' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>æ™¯é» â›©ï¸</button>
                                            <button onClick={() => setEditPlanBuffer({...editPlanBuffer, type: 'restaurant'})} className={`flex-1 py-3 rounded-2xl font-black text-sm border-4 transition-all ${editPlanBuffer.type === 'restaurant' ? 'border-orange-400 bg-orange-50 text-orange-400' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>é¤å»³ ğŸ´</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é è¨ˆæ™‚é–“</label>
                                        <input value={editPlanBuffer.time} onChange={(e) => setEditPlanBuffer({...editPlanBuffer, time: e.target.value})} placeholder="14:30" className="w-full border-2 border-purple-50 p-4 text-3xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-2xl mt-1" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è¨ˆç•«å…§å®¹</label>
                                        <input value={editPlanBuffer.title} onChange={(e) => setEditPlanBuffer({...editPlanBuffer, title: e.target.value})} placeholder="è¦å»å“ªè£¡å‘¢ï¼Ÿ" className="w-full border-2 border-purple-50 p-4 text-2xl font-black focus:border-purple-400 outline-none bg-slate-50 rounded-2xl mt-1" />
                                    </div>
                                </div>
                                <div className="flex gap-4 pt-2">
                                    <button onClick={savePlan} disabled={isSaving} className="flex-1 kuromi-gradient text-white py-5 rounded-full font-black text-2xl shadow-lg active:scale-95 disabled:opacity-50">{isSaving ? <Icon name="refresh" className="animate-spin-custom" size={24} /> : "å„²å­˜ ğŸ’œ"}</button>
                                    <button onClick={() => { setIsEditingPlan(false); setEditingPlan(null); }} className="px-8 bg-slate-100 text-slate-400 rounded-full font-black text-sm text-center transition-all">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="fixed bottom-0 left-0 right-0 h-4 kuromi-gradient z-[60]" />
                </div>
            );
        };

        const container = document.getElementById('root');
        if (container) { const root = ReactDOM.createRoot(container); root.render(<App />); }
    </script>
</body>
</html>
