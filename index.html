<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡ 2026 | Kuromi å®¶æ—å¤§å†’éšª</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=ZCOOL+KuaiLe&display=swap');
        
        :root {
            --kuromi-purple: #9D76C1;
            --kuromi-dark: #2D2727;
            --kuromi-pink: #FF91C1;
            --kuromi-bg: #F9F7FC;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--kuromi-bg); 
            color: var(--kuromi-dark);
            background-image: radial-gradient(var(--kuromi-purple) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        [v-cloak] { display: none; }
        
        .kuromi-gradient { background: linear-gradient(135deg, #9D76C1 0%, #765898 100%); }
        .tab-active { color: var(--kuromi-purple); border-bottom: 4px solid var(--kuromi-purple); }
        .day-active { background-color: var(--kuromi-purple); color: white; transform: translateY(-5px); box-shadow: 0 8px 15px rgba(157, 118, 193, 0.4); }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: floating 3s ease-in-out infinite; }

        @keyframes skeleton-loading {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }
        .loading-shimmer { animation: skeleton-loading 1.5s infinite ease-in-out; }

        @keyframes pulse-purple {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(157, 118, 193, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(157, 118, 193, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(157, 118, 193, 0); }
        }
        .big-map-btn { animation: pulse-purple 2s infinite; }
        
        .kuromi-card { 
            background: white; 
            border-radius: 35px; 
            border: 3px solid #E2D9F3; 
            position: relative;
            overflow: hidden;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative pb-32 overflow-x-hidden">
        
        <!-- Header -->
        <header class="kuromi-gradient text-white p-8 pt-14 rounded-b-[60px] shadow-2xl relative">
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 opacity-20">
                <svg width="200" height="100" viewBox="0 0 200 100">
                    <path d="M40,100 L0,20 L60,60 Z" fill="black" />
                    <path d="M160,100 L200,20 L140,60 Z" fill="black" />
                </svg>
            </div>

            <div class="flex justify-between items-center relative z-10">
                <div class="flex-1 pr-2">
                    <h1 class="text-6xl font-bold tracking-tighter" style="font-family: 'ZCOOL KuaiLe', cursive;">ç¦å²¡ 2026</h1>
                    <div class="flex items-center gap-2 mt-4">
                        <span class="bg-black/30 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest">KCY FAMILY</span>
                        <i data-lucide="heart" class="w-4 h-4 fill-pink-400 text-pink-400"></i>
                    </div>
                </div>
                
                <!-- å¤©æ°£å€å¡Š -->
                <div @click="handleWeatherClick"
                     :class="['bg-black/40 p-4 rounded-[40px] backdrop-blur-xl text-center border border-white/20 min-w-[120px] float-anim cursor-pointer hover:bg-black/60 active:scale-95 transition-all shadow-lg', weather.status === 'loading' ? 'loading-shimmer' : '']">
                    
                    <div v-if="weather.status === 'loading'" class="py-4">
                        <i data-lucide="refresh-cw" class="w-8 h-8 animate-spin mx-auto text-purple-200"></i>
                        <p class="text-[10px] mt-2 opacity-50 uppercase">Syncing</p>
                    </div>

                    <div v-else>
                        <div class="flex justify-center mb-1">
                            <i v-if="weather.icon === 'sun'" data-lucide="sun" class="w-12 h-12 text-yellow-400"></i>
                            <i v-else-if="weather.icon === 'cloud-sun'" data-lucide="cloud-sun" class="w-12 h-12 text-[#FF91C1]"></i>
                            <i v-else-if="weather.icon === 'cloud'" data-lucide="cloud" class="w-12 h-12 text-slate-300"></i>
                            <i v-else-if="weather.icon === 'cloud-rain'" data-lucide="cloud-rain" class="w-12 h-12 text-blue-400"></i>
                            <i v-else-if="weather.icon === 'snowflake'" data-lucide="snowflake" class="w-12 h-12 text-cyan-200"></i>
                            <i v-else data-lucide="cloud-lightning" class="w-12 h-12 text-[#FF91C1]"></i>
                        </div>
                        <p class="text-3xl font-black">{{ weather.temp }}Â°C</p>
                        <p class="text-[10px] opacity-80 font-bold uppercase tracking-tighter mt-1">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- å°è¦½é ç±¤ -->
        <nav class="flex bg-white/90 backdrop-blur-lg sticky top-0 z-50 px-4 mt-4 border-b-2 border-purple-100 shadow-sm">
            <button @click="activeTab = 'itinerary'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'itinerary' ? 'tab-active' : 'text-slate-400']">å†’éšªè¡Œç¨‹</button>
            <button @click="activeTab = 'expense'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'expense' ? 'tab-active' : 'text-slate-400']">éŒ¢åŒ…ç®¡å®¶</button>
            <button @click="activeTab = 'tools'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'tools' ? 'tab-active' : 'text-slate-300']">ç™¾å¯¶ç®±</button>
        </nav>

        <!-- 1. è¡Œç¨‹åˆ†é  -->
        <div v-if="activeTab === 'itinerary'">
            <div class="px-6 py-8 relative">
                <button @click="openExternal('https://maps.app.goo.gl/pd5Mgn8orC6EG7dc6')" 
                        class="big-map-btn w-full bg-[#2D2727] text-white py-8 rounded-[40px] flex items-center justify-center gap-5 shadow-2xl border-4 border-[#9D76C1] relative overflow-hidden">
                    <i data-lucide="map-pinned" class="w-10 h-10 text-[#FF91C1]"></i>
                    <div class="text-left">
                        <p class="text-2xl font-bold">æ‰“é–‹åœ°åœ–æ”¶è—</p>
                        <p class="text-[10px] opacity-60 font-bold italic">Ruby æœ€æ„›çš„ç§˜å¯†åŸºåœ° ğŸ’œ</p>
                    </div>
                </button>
            </div>

            <!-- åŒæ­¥ç‹€æ…‹æç¤º -->
            <div v-if="syncStatus === 'loading'" class="px-6 pb-4 text-center">
                <p class="text-[10px] text-purple-400 font-bold animate-pulse uppercase tracking-widest">æ­£åœ¨å¾è©¦ç®—è¡¨åŒæ­¥è¡Œç¨‹è³‡æ–™...</p>
            </div>

            <div class="flex overflow-x-auto px-6 space-x-4 hide-scrollbar py-2">
                <div v-for="(day, index) in itinerary" :key="index" @click="selectedDay = index"
                     :class="['flex-shrink-0 w-16 h-22 rounded-3xl flex flex-col items-center justify-center transition-all border-4', 
                              selectedDay === index ? 'day-active border-transparent' : 'bg-white border-[#E2D9F3] text-slate-400 shadow-sm']">
                    <span class="text-[10px] font-bold uppercase">{{ day.dayName }}</span>
                    <span class="text-2xl font-black">{{ day.date.split('/')[1] }}</span>
                </div>
            </div>

            <main class="px-6 mt-6 pb-10">
                <div class="flex items-center gap-2 mb-6">
                    <div class="w-2 h-8 bg-[#FF91C1] rounded-full"></div>
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight">{{ itinerary[selectedDay].date }} è¨ˆç•«</h2>
                </div>

                <div v-for="plan in itinerary[selectedDay].plans" class="kuromi-card p-6 mb-5 shadow-lg flex justify-between items-center group">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[11px] font-bold text-white bg-[#9D76C1] px-3 py-1 rounded-full">{{ plan.time }}</span>
                        </div>
                        <p class="font-bold text-slate-700 text-xl leading-tight">{{ plan.title }}</p>
                    </div>
                    <button @click="openExternal(plan.title)" class="p-5 bg-[#F5F3F7] rounded-[30px] text-[#9D76C1] shadow-inner active:scale-90 transition">
                        <i data-lucide="navigation-2" class="w-7 h-7"></i>
                    </button>
                </div>
                
                <div v-if="itinerary[selectedDay].plans.length === 0" class="text-center py-10 opacity-30">
                    <i data-lucide="calendar-dashed" class="w-12 h-12 mx-auto mb-2"></i>
                    <p class="text-sm font-bold">é€™å¤©æš«æ™‚æ²’æœ‰å®‰æ’è¡Œç¨‹å”·</p>
                </div>
            </main>
        </div>

        <!-- 2. è¨˜å¸³åˆ†é  -->
        <div v-if="activeTab === 'expense'" class="p-6 space-y-8">
            <div class="kuromi-card bg-[#2D2727] text-white p-8 shadow-2xl border-none">
                <div class="flex justify-between items-start mb-6">
                    <p class="text-xs text-[#FF91C1] font-bold tracking-widest uppercase">Kuromi Exchange 0.21</p>
                    <i data-lucide="skull" class="w-6 h-6 text-[#9D76C1] opacity-50"></i>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <label class="text-[10px] opacity-40 uppercase font-bold">JPY Â¥</label>
                        <input v-model.number="fxInput" type="number" placeholder="0" class="w-full bg-transparent text-5xl font-bold focus:outline-none placeholder:text-white/5">
                    </div>
                    <div class="text-right ml-4">
                        <p class="text-xs opacity-40 font-bold uppercase">TWD $</p>
                        <p class="text-4xl font-bold text-[#FF91C1]">{{ Math.round(fxInput * 0.21).toLocaleString() }}</p>
                    </div>
                </div>
            </div>

            <div class="kuromi-card p-8 space-y-6 shadow-xl">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-800">æ–°å¢æ”¯å‡º ğŸ’œ</h3>
                    <select v-model="newExpense.payer" class="bg-purple-50 rounded-2xl px-4 py-2 font-bold text-sm text-[#9D76C1] border-none outline-none shadow-inner">
                        <option v-for="m in members" :key="m">{{m}}</option>
                    </select>
                </div>
                <input v-model="newExpense.date" type="date" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:outline-none focus:border-[#9D76C1] bg-transparent">
                <input v-model="newExpense.item" placeholder="å“é …åç¨±" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:outline-none">
                <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡ (æ—¥å¹£ Â¥)" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:outline-none">
                <button @click="addExpense" class="w-full kuromi-gradient text-white py-5 rounded-[30px] font-bold text-lg shadow-xl active:scale-95 transition">ç´€éŒ„é€™ç­†é–‹éŠ·</button>
            </div>
            
            <div class="space-y-4">
                <div v-for="(ex, idx) in expenses" :key="idx" class="kuromi-card p-6 flex justify-between items-center shadow-md border-l-[12px] border-[#9D76C1]">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-white bg-slate-800 px-2 py-0.5 rounded">{{ex.date}}</span>
                            <span class="text-[10px] text-slate-300 font-bold">{{ex.payer}}</span>
                        </div>
                        <p class="text-lg font-bold text-slate-700">{{ex.item}}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-slate-800">Â¥ {{ex.amount.toLocaleString()}}</p>
                        <p class="text-xs font-bold text-[#FF91C1]">NT$ {{ Math.round(ex.amount * 0.21).toLocaleString() }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. å·¥å…·èˆ‡æ¸…å–® -->
        <div v-if="activeTab === 'tools'" class="p-6 space-y-10">
            <section class="kuromi-card p-8 bg-white border-4 border-[#9D76C1] shadow-2xl relative">
                <div class="absolute -right-4 -top-4 float-anim">
                    <svg width="60" height="60" viewBox="0 0 60 60">
                        <path d="M30,5 L55,30 L30,55 L5,30 Z" fill="#FF91C1" opacity="0.4" />
                        <circle cx="30" cy="30" r="10" fill="#9D76C1" />
                    </svg>
                </div>
                <h3 class="font-black text-2xl mb-1 text-[#2D2727]">åšå¤šè¥¿éµ CROOM</h3>
                <p class="text-xs text-slate-400 mb-6 font-bold uppercase tracking-widest">åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰</p>
                <div class="flex gap-4">
                    <button @click="openExternal('åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—')" class="flex-1 bg-[#2D2727] text-white py-4 rounded-[25px] text-xs font-bold shadow-lg">åœ°åœ–å®šä½ ğŸ“</button>
                    <a href="tel:092-235-0311" class="flex-1 border-4 border-[#2D2727] text-center py-4 rounded-[25px] text-xs font-bold">æ’¥æ‰“é›»è©± ğŸ“</a>
                </div>
            </section>

            <section>
                <h3 class="font-black text-2xl text-slate-800 mb-6 px-4 flex items-center gap-3">
                    <i data-lucide="luggage" class="text-[#FF91C1] w-8 h-8"></i> è¡Œææ¸…å–®
                </h3>
                <div v-for="cat in packing" class="mb-10">
                    <p class="text-xs font-black text-[#9D76C1] mb-4 px-4 uppercase tracking-[0.2em] border-l-4 border-[#9D76C1] ml-4">{{cat.category}}</p>
                    <div class="space-y-3">
                        <div v-for="item in cat.items" @click="item.done = !item.done"
                             class="kuromi-card p-5 flex items-center gap-5 transition-all active:scale-95" :class="{'bg-purple-50 border-transparent opacity-60': item.done}">
                            <div class="w-8 h-8 rounded-full border-4 border-[#9D76C1] flex items-center justify-center transition-colors" :class="{'bg-[#9D76C1]': item.done}">
                                <i v-if="item.done" data-lucide="check" class="text-white w-5 h-5"></i>
                            </div>
                            <span class="text-md font-bold text-slate-700" :class="{'line-through': item.done}">{{item.text}}</span>
                        </div>
                    </div>
                </div>

                <!-- æ³¨æ„äº‹é … -->
                <div class="kuromi-card p-6 bg-slate-900 text-white border-none shadow-xl">
                    <h4 class="font-bold text-[#FF91C1] mb-4 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> æ‰˜é‹èˆ‡æ‰‹ææ³¨æ„äº‹é …
                    </h4>
                    <ul class="text-[11px] space-y-3 opacity-90">
                        <li class="flex gap-2"><span class="text-[#9D76C1]">â—</span><span><b>æ¶²é«”ï¼š</b>æ‰‹æä¸å¾—è¶…é 100mlï¼Œéœ€è£å…¥é€æ˜å¤¾éˆè¢‹ (ç¸½é‡ä¸è¶…é 1L)ã€‚</span></li>
                        <li class="flex gap-2"><span class="text-[#9D76C1]">â—</span><span><b>æ‰“ç«æ©Ÿï¼š</b>ä¸€èˆ¬æ‰“ç«æ©Ÿåƒ…é™ 1 å€‹å¯æ‰‹æï¼Œå…¶ä»–åš´ç¦ã€‚</span></li>
                        <li class="flex gap-2"><span class="text-[#9D76C1]">â—</span><span><b>é›»æ± ï¼š</b>è¡Œå‹•é›»æº/é‹°é›»æ± åªèƒ½æ‰‹æï¼Œ<b>ä¸å¯æ‰˜é‹</b>ã€‚</span></li>
                        <li class="flex gap-2"><span class="text-[#9D76C1]">â—</span><span><b>å™´éœ§ï¼š</b>è‹¥å«æ˜“ç‡ƒæˆåˆ†ä¸èƒ½æ‰‹æä¹Ÿä¸èƒ½æ‰˜é‹ã€‚</span></li>
                    </ul>
                </div>
            </section>
        </div>

        <div class="fixed bottom-0 left-0 right-0 h-4 kuromi-gradient z-[60]"></div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;
        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDay = ref(0);
                const fxInput = ref(null);
                const members = ['KCY', 'Ruby', 'YSL', 'Tsai'];
                const expenses = ref([]);
                const newExpense = ref({ date: '2026-05-30', item: '', amount: null, payer: 'KCY' });
                const syncStatus = ref('loading');

                const weather = ref({ temp: '--', icon: 'thermometer', desc: 'Syncing', status: 'loading' });

                // åˆå§‹è¡Œç¨‹è³‡æ–™ (å‚™æ´ç”¨)
                const itinerary = ref([
                    { date: '5/30', dayName: 'SAT', plans: [] },
                    { date: '5/31', dayName: 'SUN', plans: [] },
                    { date: '6/01', dayName: 'MON', plans: [] },
                    { date: '6/02', dayName: 'TUE', plans: [] },
                    { date: '6/03', dayName: 'WED', plans: [] },
                    { date: '6/04', dayName: 'THU', plans: [] },
                    { date: '6/05', dayName: 'FRI', plans: [] },
                    { date: '6/06', dayName: 'SAT', plans: [] }
                ]);

                const packing = ref([
                    { category: 'ä¸€ã€å¿…å‚™è­‰ä»¶èˆ‡è²¡å‹™ (éš¨èº«è¡Œæ)', items: [
                        {text: 'è­·ç…§ (6å€‹æœˆä»¥ä¸Šæ•ˆæœŸ)', done: false}, {text: 'ç°½è­‰ã€æ©Ÿç¥¨/è¨‚ä½ç´€éŒ„', done: false},
                        {text: 'èº«åˆ†è­‰ã€é§•ç…§ã€ä¿éšªæ–‡ä»¶', done: false}, {text: 'ä¿¡ç”¨å¡ã€ç•¶åœ°ç¾é‡‘', done: false},
                        {text: 'ç·Šæ€¥è¯çµ¡è³‡è¨Š', done: false}
                    ]},
                    { category: 'äºŒã€è¡£ç‰©èˆ‡é…ä»¶', items: [
                        {text: 'æ—¥å¸¸è¡£ç‰©/å…§è¡£è¤²/ç¡è¡£/è¥ªå­', done: false}, {text: 'èˆ’é©é‹å­/æ‹–é‹', done: false},
                        {text: 'å¸½å­/å¤ªé™½çœ¼é¡/åœå·¾/æ‰‹å¥—', done: false}, {text: 'ç‰¹æ®Šéœ€æ±‚ (æ³³è¡£/é‹å‹•æœ)', done: false}
                    ]},
                    { category: 'ä¸‰ã€ç›¥æ´—èˆ‡ä¿é¤Šå“', items: [
                        {text: 'ç‰™åˆ·ç‰™è†/æ¢³å­/æ´—é¢ä¹³', done: false}, {text: 'æ—…è¡Œè£æ²æµ´ä¹³/æ´—é«®ç²¾', done: false},
                        {text: 'ä¿é¤Šå“ (ä¹³æ¶²/é˜²æ›¬/å¸å¦)', done: false}, {text: 'è¡›ç”Ÿç´™/æ¿•ç´™å·¾/ç”Ÿç†ç”¨å“', done: false}
                    ]},
                    { category: 'å››ã€3Cç”¢å“ & é›»å­ç”¨å“', items: [
                        {text: 'æ‰‹æ©Ÿ/å……é›»å™¨/å……é›»ç·š/è€³æ©Ÿ', done: false}, {text: 'è¡Œå‹•é›»æº (ä¸å¯æ‰˜é‹)', done: false},
                        {text: 'è¬ç”¨æ’é ­/ç¶²å¡/WiFiæ©Ÿ', done: false}, {text: 'ç›¸æ©Ÿ/ç­†é›»', done: false}
                    ]},
                    { category: 'äº”ã€è—¥å“èˆ‡ä¿å¥å“', items: [
                        {text: 'æ„Ÿå†’/æ­¢ç—›/è…¸èƒƒ/éæ•è—¥', done: false}, {text: 'å€‹äººè™•æ–¹è—¥/èšŠèŸ²è—¥', done: false},
                        {text: 'Ruby å¸¸å‚™è—¥/å£ç½©', done: false}, {text: 'OKç¹ƒ/é˜²èšŠæ¶²', done: false}
                    ]},
                    { category: 'å…­ã€å…¶ä»–é›œç‰©', items: [
                        {text: 'æ°´ç“¶/é›¨å‚˜/ç­†/ç’°ä¿è¢‹', done: false}, {text: 'è¡Œæç§¤/é ¸æ•/çœ¼ç½©/è€³å¡', done: false},
                        {text: 'è¡ŒææŸå¸¶/è¡Œæé– (æ‰˜é‹)', done: false}
                    ]}
                ]);

                // æ ¸å¿ƒåŠŸèƒ½ï¼šå¾ Google è©¦ç®—è¡¨æŠ“å–è¡Œç¨‹
                const fetchItineraryFromSheet = async () => {
                    const sheetId = '19REJaflyB3ipjTvvQABcAMe95wjiBKwQNf7eH8J97N8';
                    const gid = '1691304811';
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    
                    try {
                        const response = await fetch(url);
                        const csvText = await response.text();
                        
                        // ç°¡å–®çš„ CSV è§£æ (å‡è¨­ç¬¬ä¸€åˆ—æ˜¯æ—¥æœŸ/æ™‚é–“/å…§å®¹)
                        const rows = csvText.split('\n').map(row => row.split(','));
                        
                        // é‡è¨­è¡Œç¨‹
                        const newItinerary = [
                            { date: '5/30', dayName: 'SAT', plans: [] },
                            { date: '5/31', dayName: 'SUN', plans: [] },
                            { date: '6/01', dayName: 'MON', plans: [] },
                            { date: '6/02', dayName: 'TUE', plans: [] },
                            { date: '6/03', dayName: 'WED', plans: [] },
                            { date: '6/04', dayName: 'THU', plans: [] },
                            { date: '6/05', dayName: 'FRI', plans: [] },
                            { date: '6/06', dayName: 'SAT', plans: [] }
                        ];

                        // è§£æé‚è¼¯ï¼šå°‹æ‰¾åŒ…å«æ—¥æœŸçš„åˆ—
                        rows.forEach(row => {
                            if (row.length < 3) return;
                            const dateStr = row[0].trim(); // é æœŸæ ¼å¼å¦‚ 5/30
                            const timeStr = row[1].trim();
                            const titleStr = row[2].replace(/"/g, '').trim();

                            const dayIndex = newItinerary.findIndex(d => d.date === dateStr);
                            if (dayIndex !== -1 && titleStr) {
                                newItinerary[dayIndex].plans.push({
                                    time: timeStr || '--:--',
                                    title: titleStr
                                });
                            }
                        });

                        itinerary.value = newItinerary;
                        syncStatus.value = 'success';
                    } catch (e) {
                        console.error('Sheet Sync Failed:', e);
                        syncStatus.value = 'error';
                        // å¤±æ•—æ™‚è¼‰å…¥ä¸€çµ„é è¨­è³‡æ–™ï¼Œé¿å…ç©ºç™½
                        itinerary.value[0].plans = [{time: '18:05', title: 'æŠµé”ç¦å²¡æ©Ÿå ´ ğŸ‡¯ğŸ‡µ'}];
                        itinerary.value[1].plans = [{time: '12:00', title: 'ç‡’è‚‰ å¤§æ±åœ’ ğŸ¥©'}];
                    }
                    await nextTick();
                    lucide.createIcons();
                };

                const handleWeatherClick = () => {
                    if (weather.value.status === 'error') {
                        weather.value.status = 'loading';
                        weather.value.desc = 'Syncing';
                        fetchWeather();
                    } else {
                        openExternal('https://tenki.jp/forecast/9/43/8210/40130/');
                    }
                };

                const fetchWeather = async () => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 7000);
                    try {
                        const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.40&current_weather=true&timezone=Asia%2FTokyo', {
                            signal: controller.signal,
                            cache: 'no-store'
                        });
                        const data = await response.json();
                        clearTimeout(timeoutId);
                        if (data && data.current_weather) {
                            updateWeatherUI(data.current_weather.temperature, data.current_weather.weathercode);
                        }
                    } catch (e) {
                        weather.value.desc = 'RETRY';
                        weather.value.temp = '??';
                        weather.value.icon = 'cloud-lightning';
                        weather.value.status = 'error';
                        await nextTick();
                        lucide.createIcons();
                    }
                };

                const updateWeatherUI = async (temp, code) => {
                    weather.value.temp = Math.round(temp);
                    weather.value.status = 'success';
                    if (code === 0) { weather.value.icon = 'sun'; weather.value.desc = 'æ™´æœ—'; }
                    else if ([1, 2, 3].includes(code)) { weather.value.icon = 'cloud-sun'; weather.value.desc = 'å¤šé›²'; }
                    else if ([45, 48].includes(code)) { weather.value.icon = 'cloud'; weather.value.desc = 'æœ‰éœ§'; }
                    else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) { weather.value.icon = 'cloud-rain'; weather.value.desc = 'æœ‰é›¨'; }
                    else if ([71, 73, 75, 77, 85, 86].includes(code)) { weather.value.icon = 'snowflake'; weather.value.desc = 'ä¸‹é›ª'; }
                    else { weather.value.icon = 'thermometer'; weather.value.desc = 'TENKI.JP'; }
                    await nextTick();
                    lucide.createIcons();
                };

                const addExpense = () => {
                    if (newExpense.value.item && newExpense.value.amount) {
                        expenses.value.unshift({ ...newExpense.value });
                        newExpense.value.item = ''; newExpense.value.amount = null;
                    }
                };

                const openExternal = (q) => {
                    const url = q.startsWith('http') ? q : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
                    window.open(url, '_blank');
                };

                onMounted(() => {
                    fetchItineraryFromSheet();
                    fetchWeather();
                });

                return { activeTab, selectedDay, fxInput, members, expenses, newExpense, itinerary, packing, weather, syncStatus, addExpense, openExternal, handleWeatherClick };
            }
        }).mount('#app');
    </script>
</body>
</html>
