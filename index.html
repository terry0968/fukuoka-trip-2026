<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡ 2026 | Kuromi å®¶æ—å¤§å†’éšª</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=ZCOOL+KuaiLe&display=swap');
        
        :root {
            --kuromi-purple: #9D76C1;
            --kuromi-dark: #2D2727;
            --kuromi-pink: #FF91C1;
            --kuromi-bg: #F9F7FC;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--kuromi-bg); 
            color: var(--kuromi-dark);
            background-image: radial-gradient(var(--kuromi-purple) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        [v-cloak] { display: none; }
        
        .kuromi-gradient { background: linear-gradient(135deg, #9D76C1 0%, #765898 100%); }
        .tab-active { color: var(--kuromi-purple); border-bottom: 4px solid var(--kuromi-purple); }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: floating 3s ease-in-out infinite; }

        @keyframes skeleton-loading {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }
        .loading-shimmer { animation: skeleton-loading 1.5s infinite ease-in-out; }

        .kuromi-card { 
            background: white; 
            border-radius: 35px; 
            border: 3px solid #E2D9F3; 
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .kuromi-card:active { transform: scale(0.92); box-shadow: inset 0 4px 10px rgba(0,0,0,0.1); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* é é¢é€²å…¥å‹•ç•« */
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.4s ease; }
        .slide-up-enter-from { transform: translateY(30px); opacity: 0; }
        .slide-up-leave-to { transform: translateY(-30px); opacity: 0; }

        html { scroll-behavior: smooth; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative pb-32 overflow-x-hidden">
        
        <!-- æˆåŠŸæç¤ºè¦–çª— -->
        <transition name="slide-up">
            <div v-if="showToast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] w-64 text-center">
                <div class="bg-black/80 text-white p-4 rounded-[25px] flex items-center justify-center gap-3 backdrop-blur-md shadow-2xl border border-purple-400">
                    <i data-lucide="check-circle" class="text-green-400"></i>
                    <p class="font-bold text-sm">{{ toastMsg }}</p>
                </div>
            </div>
        </transition>

        <!-- Header -->
        <header class="kuromi-gradient text-white p-8 pt-14 rounded-b-[60px] shadow-2xl relative">
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 opacity-20">
                <svg width="200" height="100" viewBox="0 0 200 100">
                    <path d="M40,100 L0,20 L60,60 Z" fill="black" />
                    <path d="M160,100 L200,20 L140,60 Z" fill="black" />
                </svg>
            </div>

            <div class="flex justify-between items-center relative z-10">
                <div class="flex-1 pr-2">
                    <h1 class="text-6xl font-bold tracking-tighter" style="font-family: 'ZCOOL KuaiLe', cursive;">ç¦å²¡ 2026</h1>
                    <div class="flex items-center gap-2 mt-4">
                        <span class="bg-black/30 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest">KCY FAMILY</span>
                        <i data-lucide="heart" class="w-4 h-4 fill-pink-400 text-pink-400"></i>
                    </div>
                </div>
                
                <div @click="handleWeatherClick"
                     :class="['bg-black/40 p-4 rounded-[40px] backdrop-blur-xl text-center border border-white/20 min-w-[120px] float-anim cursor-pointer hover:bg-black/60 active:scale-95 transition-all shadow-lg', weather.status === 'loading' ? 'loading-shimmer' : '']">
                    <div v-if="weather.status === 'loading'">
                        <i data-lucide="refresh-cw" class="w-8 h-8 animate-spin mx-auto text-purple-200"></i>
                    </div>
                    <div v-else>
                        <div class="flex justify-center mb-1">
                            <i v-if="weather.icon === 'sun'" data-lucide="sun" class="w-12 h-12 text-yellow-400"></i>
                            <i v-else-if="weather.icon === 'cloud-sun'" data-lucide="cloud-sun" class="w-12 h-12 text-[#FF91C1]"></i>
                            <i v-else-if="weather.icon === 'cloud'" data-lucide="cloud" class="w-12 h-12 text-slate-300"></i>
                            <i v-else-if="weather.icon === 'cloud-rain'" data-lucide="cloud-rain" class="w-12 h-12 text-blue-400"></i>
                            <i v-else data-lucide="snowflake" class="w-12 h-12 text-cyan-200"></i>
                        </div>
                        <p class="text-3xl font-black">{{ weather.temp }}Â°C</p>
                        <p class="text-[10px] opacity-80 font-bold uppercase mt-1">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- å°è¦½é ç±¤ -->
        <nav v-if="itineraryView === 'list'" class="flex bg-white/90 backdrop-blur-lg sticky top-0 z-50 px-4 mt-4 border-b-2 border-purple-100 shadow-sm">
            <button @click="activeTab = 'itinerary'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'itinerary' ? 'tab-active' : 'text-slate-400']">å†’éšªè¡Œç¨‹</button>
            <button @click="activeTab = 'expense'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'expense' ? 'tab-active' : 'text-slate-400']">éŒ¢åŒ…ç®¡å®¶</button>
            <button @click="activeTab = 'tools'" :class="['flex-1 py-5 font-bold text-sm transition-all', activeTab === 'tools' ? 'tab-active' : 'text-slate-300']">ç™¾å¯¶ç®±</button>
        </nav>

        <!-- 1. è¡Œç¨‹åˆ†é  -->
        <div v-if="activeTab === 'itinerary'">
            
            <!-- (A) è¡Œç¨‹é¦–é ï¼šæ—¥æœŸå¤§æŒ‰éˆ• -->
            <transition name="slide-up">
                <div v-if="itineraryView === 'list'" class="px-6 py-8 space-y-6">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-2xl font-black text-slate-800 text-center">é¸å€‹æ—¥æœŸé–‹å§‹å†’éšª ğŸ’œ</h2>
                        <button @click="fetchItineraryFromSheet" class="p-2 text-purple-400 active:rotate-180 transition-all duration-500">
                            <i data-lucide="refresh-cw" :class="{'animate-spin': syncStatus === 'loading'}"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div v-for="(day, index) in itinerary" :key="day.date" 
                             @click="goToDetail(index)"
                             class="kuromi-card p-8 flex flex-col items-center justify-center text-center shadow-lg border-b-8 border-[#9D76C1] hover:border-pink-300 relative">
                            <span class="text-xs font-black text-purple-300 uppercase tracking-widest mb-1">{{ day.dayName }}</span>
                            <span class="text-5xl font-black text-slate-700 mb-2">{{ day.date.split('/')[1] }}</span>
                            <span class="text-[10px] font-bold text-white bg-purple-400 px-3 py-1 rounded-full">{{ day.date }}</span>
                            <!-- è¡Œç¨‹æç¤ºå°åœ“é» -->
                            <div v-if="day.plans.length > 0" class="absolute top-4 right-4 w-3 h-3 bg-pink-400 rounded-full animate-pulse shadow-sm"></div>
                        </div>
                    </div>

                    <button @click="openExternal('https://maps.app.goo.gl/pd5Mgn8orC6EG7dc6')" 
                            class="w-full bg-[#2D2727] text-white py-6 rounded-[35px] flex items-center justify-center gap-4 shadow-xl active:scale-95 transition-all mt-4 border-2 border-purple-900/10">
                        <i data-lucide="map-pinned" class="text-pink-400 w-6 h-6"></i>
                        <span class="font-black tracking-widest">é–‹å•Ÿ Google åœ°åœ–æ™¯é»</span>
                    </button>
                </div>

                <!-- (B) è¡Œç¨‹è©³æƒ…é  -->
                <div v-else-if="itineraryView === 'detail'" class="px-6 py-8 min-h-screen">
                    <div class="flex items-center gap-5 mb-10">
                        <button @click="itineraryView = 'list'" class="p-5 bg-white rounded-full shadow-lg text-purple-600 active:scale-75 transition-all border border-purple-50">
                            <i data-lucide="chevron-left" class="w-8 h-8"></i>
                        </button>
                        <div>
                            <h2 class="text-4xl font-black text-slate-800 tracking-tighter">{{ itinerary[selectedDay].date }}</h2>
                            <p class="text-xs font-black text-purple-400 uppercase tracking-[0.3em] mt-1">{{ itinerary[selectedDay].dayName }} è¨ˆç•«æ¸…å–®</p>
                        </div>
                    </div>

                    <!-- è¡Œç¨‹åˆ—è¡¨ -->
                    <div v-if="itinerary[selectedDay].plans.length > 0" class="space-y-6">
                        <div v-for="(plan, pIdx) in itinerary[selectedDay].plans" :key="pIdx" 
                             class="kuromi-card p-6 flex flex-col shadow-xl border-l-[15px] border-[#9D76C1] cursor-default">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-[12px] font-black text-white bg-slate-800 px-4 py-1.5 rounded-full shadow-md tracking-tighter">{{ plan.time }}</span>
                                <div class="flex gap-2">
                                    <button @click="startEditPlan(pIdx)" class="p-3 bg-purple-50 text-purple-400 rounded-full active:scale-75 transition">
                                        <i data-lucide="pencil-line" class="w-4 h-4"></i>
                                    </button>
                                    <button @click="openExternal(plan.title)" class="p-3 bg-pink-50 text-pink-400 rounded-full active:scale-75 transition">
                                        <i data-lucide="navigation" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <h3 class="text-2xl font-black text-slate-700 leading-tight pr-4">{{ plan.title }}</h3>
                        </div>
                    </div>

                    <div v-else class="py-32 text-center opacity-20">
                        <i data-lucide="sparkles" class="w-20 h-20 mx-auto mb-6 text-purple-200"></i>
                        <p class="font-black text-xl tracking-widest uppercase">No Plans Yet</p>
                    </div>

                    <!-- è¡Œç¨‹ç·¨è¼¯å½ˆçª— -->
                    <div v-if="isEditingPlan" class="fixed inset-0 z-[110] bg-black/60 backdrop-blur-md flex items-center justify-center p-6">
                        <div class="bg-white w-full rounded-[40px] p-8 shadow-2xl space-y-6 border-4 border-purple-200">
                            <h3 class="text-xl font-black text-slate-800 flex items-center gap-2 italic">
                                <i data-lucide="edit-3" class="text-purple-500"></i> ç·¨è¼¯è¨ˆç•«ä¸¦åŒæ­¥ âœï¸
                            </h3>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">æ™‚é–“ (Aæ¬„)</label>
                                <input v-model="editPlanBuffer.time" class="w-full border-b-4 border-purple-50 p-3 text-lg font-bold focus:border-purple-400 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">è¨ˆç•«å…§å®¹ ({{ itinerary[selectedDay].date }})</label>
                                <input v-model="editPlanBuffer.title" class="w-full border-b-4 border-purple-50 p-3 text-lg font-bold focus:border-purple-400 outline-none">
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button @click="savePlanChange" :disabled="isSaving" class="flex-1 kuromi-gradient text-white py-5 rounded-[30px] font-black shadow-lg flex items-center justify-center gap-2 active:scale-95">
                                    <i v-if="isSaving" data-lucide="loader-2" class="animate-spin"></i>
                                    {{ isSaving ? 'åŒæ­¥ä¸­' : 'å„²å­˜ä¿®æ”¹ ğŸ’œ' }}
                                </button>
                                <button @click="isEditingPlan = false" class="px-8 bg-slate-100 text-slate-400 rounded-[30px] font-bold">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </div>

        <!-- 2. éŒ¢åŒ…ç®¡å®¶ (è¨˜å¸³åˆ†é ) -->
        <div v-if="activeTab === 'expense'" class="p-6 space-y-8">
            <div class="kuromi-card bg-[#2D2727] text-white p-8 border-none shadow-2xl">
                <div class="flex justify-between items-start mb-4">
                    <p class="text-xs text-[#FF91C1] font-bold uppercase tracking-widest">JPY â®• TWD åŒ¯ç‡</p>
                    <i data-lucide="banknote" class="w-6 h-6 text-[#9D76C1]"></i>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <input v-model.number="fxInput" type="number" placeholder="0" class="w-full bg-transparent text-5xl font-bold focus:outline-none placeholder:text-white/10">
                    </div>
                    <div class="text-right">
                        <p class="text-xs opacity-40 font-bold uppercase">NT$</p>
                        <p class="text-4xl font-bold text-[#FF91C1]">{{ Math.round(fxInput * exchangeRate).toLocaleString() }}</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-between text-[10px] text-slate-500 font-bold">
                    <span>1 JPY = {{ exchangeRate }} TWD</span>
                    <button @click="fetchExchangeRate" class="text-purple-300">ğŸ”„ æ›´æ–°åŒ¯ç‡</button>
                </div>
            </div>

            <!-- æ–°å¢æ”¯å‡º -->
            <div id="expense-form" class="kuromi-card p-8 space-y-6 shadow-xl border-2 border-purple-100 relative">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-black text-slate-800 italic underline decoration-pink-300">{{ isEditing ? 'ä¿®æ”¹ç´€éŒ„' : 'æ–°å¢æ”¯å‡º' }} ğŸ’œ</h3>
                    <select v-model="newExpense.payer" class="bg-purple-50 rounded-2xl px-4 py-2 font-bold text-sm text-[#9D76C1] outline-none shadow-inner">
                        <option v-for="m in members" :key="m">{{m}}</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <input v-model="newExpense.date" type="date" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:border-purple-400 outline-none bg-transparent">
                    <input v-model="newExpense.item" placeholder="å“é …åç¨±" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:border-purple-400 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input v-model.number="newExpense.amount" @input="convertCurrency('jpy')" type="number" placeholder="æ—¥å¹£ Â¥" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:border-purple-400 outline-none">
                    <input v-model.number="newExpense.amountTwd" @input="convertCurrency('twd')" type="number" placeholder="å°å¹£ $" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:border-purple-400 outline-none">
                </div>
                <input v-model="newExpense.remark" placeholder="å‚™è¨» (ä¾‹å¦‚ï¼šåˆ·å¡ã€å¥½åƒã€åˆ†å¸³...)" class="w-full border-b-2 border-purple-50 pb-3 text-sm focus:border-purple-400 outline-none">

                <div class="flex gap-2">
                    <button @click="addExpense" :disabled="isSaving" class="flex-1 kuromi-gradient text-white py-5 rounded-[30px] font-bold text-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i v-if="isSaving" data-lucide="loader-2" class="animate-spin"></i>
                        {{ isSaving ? 'åŒæ­¥ä¸­' : 'ç´€éŒ„æ”¯å‡º ğŸ’œ' }}
                    </button>
                    <button v-if="isEditing" @click="cancelEdit" class="px-6 bg-slate-100 text-slate-400 rounded-[30px] font-bold text-sm">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- æ˜ç´°æ¸…å–® -->
            <div class="space-y-4 pb-10">
                <div v-for="(ex, idx) in expenses" :key="ex.id" class="kuromi-card p-6 flex flex-col shadow-md border-l-[12px] border-[#9D76C1]">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 mr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold text-white bg-slate-800 px-2 py-0.5 rounded">{{ex.date}}</span>
                                <span class="text-[10px] text-slate-400 font-bold uppercase">{{ex.payer}}</span>
                            </div>
                            <p class="text-lg font-bold text-slate-700">{{ex.item}}</p>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            <div>
                                <p class="text-xl font-bold text-slate-800">Â¥ {{ex.amount.toLocaleString()}}</p>
                                <p class="text-[11px] font-bold text-pink-400">NT$ {{ex.amountTwd.toLocaleString()}}</p>
                            </div>
                            <button @click="editItem(ex)" class="p-3 bg-purple-50 text-purple-400 rounded-full active:scale-90 transition shadow-inner">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p v-if="ex.remark" class="mt-3 text-[11px] text-slate-400 bg-slate-50 p-2 px-3 rounded-2xl italic border border-slate-100">{{ ex.remark }}</p>
                </div>
            </div>
        </div>

        <!-- 3. ç™¾å¯¶ç®± -->
        <div v-if="activeTab === 'tools'" class="p-6 space-y-10">
            <section class="kuromi-card p-8 bg-white border-4 border-[#9D76C1] shadow-2xl">
                <h3 class="font-black text-2xl mb-1 text-[#2D2727]">åšå¤šè¥¿éµ CROOM</h3>
                <p class="text-xs text-slate-400 mb-6 font-bold uppercase">æ«›ç”°ç¥ç¤¾å‰ç«™ 4 è™Ÿå‡ºå£å°é¢</p>
                <div class="flex gap-4">
                    <button @click="openExternal('åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—')" class="flex-1 bg-[#2D2727] text-white py-4 rounded-[25px] text-xs font-bold shadow-lg">åœ°åœ–å®šä½ ğŸ“</button>
                    <a href="tel:092-235-0311" class="flex-1 border-4 border-[#2D2727] text-center py-4 rounded-[25px] text-xs font-bold flex items-center justify-center">æ’¥æ‰“é›»è©± ğŸ“</a>
                </div>
            </section>

            <section>
                <h3 class="font-black text-2xl text-slate-800 mb-6 px-4">è¡Œææ¸…å–® ğŸ§³</h3>
                <div v-for="cat in packing" :key="cat.category" class="mb-10">
                    <p class="text-xs font-black text-[#9D76C1] mb-4 border-l-4 border-[#9D76C1] pl-4 ml-2 uppercase tracking-widest">{{cat.category}}</p>
                    <div class="space-y-3 px-2">
                        <div v-for="item in cat.items" :key="item.text" @click="item.done = !item.done"
                             class="kuromi-card p-5 flex items-center gap-5" :class="{'opacity-50 grayscale bg-slate-50 border-transparent': item.done}">
                            <div class="w-8 h-8 rounded-full border-4 border-purple-300 flex items-center justify-center transition-colors" :class="{'bg-purple-500 border-purple-500': item.done}">
                                <i v-if="item.done" data-lucide="check" class="text-white w-4 h-4"></i>
                            </div>
                            <span class="text-md font-bold text-slate-700" :class="{'line-through': item.done}">{{item.text}}</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="fixed bottom-0 left-0 right-0 h-4 kuromi-gradient z-[60]"></div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        createApp({
            setup() {
                const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxUaoB_wXAYkZh3cW0S5HB_41Gw4wYI-mBkMjIYWOThVRgS-4e8bmWOTclAwLUkOUY/exec"; 
                const SHEET_ID = '19REJaflyB3ipjTvvQABcAMe95wjiBKwQNf7eH8J97N8';
                const ITINERARY_GID = '1691304811';
                const EXPENSE_GID = '146729228';

                const activeTab = ref('itinerary');
                const itineraryView = ref('list'); 
                const selectedDay = ref(0);
                const members = ['KCY', 'Ruby', 'YSL', 'Tsai'];
                const expenses = ref([]);
                const exchangeRate = ref(0.210);
                const fxInput = ref(null);
                const fxDate = ref('Loading...');
                const isSaving = ref(false);
                const isEditing = ref(false);
                const showToast = ref(false);
                const toastMsg = ref('');
                const syncStatus = ref('idle');
                const syncCount = ref(0);

                const itinerary = ref([
                    { date: '5/30', dayName: 'SAT', plans: [] }, { date: '5/31', dayName: 'SUN', plans: [] },
                    { date: '6/1', dayName: 'MON', plans: [] }, { date: '6/2', dayName: 'TUE', plans: [] },
                    { date: '6/3', dayName: 'WED', plans: [] }, { date: '6/4', dayName: 'THU', plans: [] },
                    { date: '6/5', dayName: 'FRI', plans: [] }, { date: '6/6', dayName: 'SAT', plans: [] }
                ]);

                const packing = ref([
                    { category: 'ä¸€ã€å¿…å‚™è­‰ä»¶', items: [{text: 'è­·ç…§ (æ•ˆæœŸ6æœˆä»¥ä¸Š)', done: false}, {text: 'æ©Ÿç¥¨è¨‚ä½ç´€éŒ„', done: false}, {text: 'æ—¥å¹£ç¾é‡‘/ä¿¡ç”¨å¡', done: false}] },
                    { category: 'äºŒã€è¡£ç‰©é…ä»¶', items: [{text: 'ç¡è¡£/è¥ªå­/å…§è¡£è¤²', done: false}, {text: 'å¥½èµ°çš„é‹', done: false}] }
                ]);

                const newExpense = ref({ id: null, date: new Date().toISOString().split('T')[0], item: '', amount: null, amountTwd: null, payer: 'KCY', remark: '' });

                const isEditingPlan = ref(false);
                const editingPlanIndex = ref(-1);
                const editPlanBuffer = ref({ time: '', title: '', oldTime: '' });

                const goToDetail = (index) => {
                    selectedDay.value = index;
                    itineraryView.value = 'detail';
                    window.scrollTo(0, 0);
                    nextTick(() => lucide.createIcons());
                };

                const startEditPlan = (pIdx) => {
                    editingPlanIndex.value = pIdx;
                    const plan = itinerary.value[selectedDay.value].plans[pIdx];
                    // ç´€éŒ„ oldTime ä»¥ä¾¿ GAS æœå°‹ A æ¬„
                    editPlanBuffer.value = { ...plan, oldTime: plan.time };
                    isEditingPlan.value = true;
                    nextTick(() => lucide.createIcons());
                };

                const savePlanChange = async () => {
                    if (!editPlanBuffer.value.title) return;
                    isSaving.value = true;
                    const plan = editPlanBuffer.value;
                    const targetDate = itinerary.value[selectedDay.value].date; // æ ¼å¼å¦‚ 5/30
                    
                    try {
                        // åŒæ­¥å› GAS
                        await fetch(GAS_WEB_APP_URL, {
                            method: "POST",
                            mode: "no-cors",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify({
                                type: 'itinerary',
                                targetDate: targetDate, 
                                oldTime: plan.oldTime,  
                                time: plan.time,        
                                title: plan.title       
                            })
                        });

                        // æœ¬åœ°å³æ™‚æ›´æ–°
                        itinerary.value[selectedDay.value].plans[editingPlanIndex.value] = { 
                            time: plan.time, title: plan.title 
                        };
                        
                        isEditingPlan.value = false;
                        toastMsg.value = "è¡Œç¨‹å·²åŒæ­¥è‡³é›²ç«¯ï¼ğŸ’œ";
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2500);
                        
                        // 3ç§’å¾Œé‡æ–°æŠ“å–ä¸€æ¬¡ç¢ºä¿ä¸€è‡´
                        setTimeout(fetchItineraryFromSheet, 3000);
                    } catch (e) {
                        toastMsg.value = "é€£ç·šå¤±æ•—";
                        showToast.value = true;
                    } finally {
                        isSaving.value = false;
                    }
                };

                const fetchExchangeRate = async () => {
                    try {
                        const res = await fetch('https://api.frankfurter.app/latest?from=JPY&to=TWD');
                        const data = await res.json();
                        if (data && data.rates.TWD) { exchangeRate.value = data.rates.TWD.toFixed(3); fxDate.value = data.date; }
                    } catch (e) { fxDate.value = 'Offline'; }
                };

                const convertCurrency = (source) => {
                    const rate = parseFloat(exchangeRate.value);
                    if (source === 'jpy') newExpense.value.amountTwd = newExpense.value.amount ? Math.round(newExpense.value.amount * rate) : null;
                    else if (source === 'twd') newExpense.value.amount = newExpense.value.amountTwd ? Math.round(newExpense.value.amountTwd / rate) : null;
                };

                const parseCSV = (text) => {
                    const rows = [];
                    const lines = text.replace(/\r/g, '').split('\n');
                    lines.forEach(line => {
                        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        rows.push(parts.map(p => p.replace(/"/g, '').trim()));
                    });
                    return rows;
                };

                const fetchExpensesFromSheet = async () => {
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${EXPENSE_GID}&t=${Date.now()}`;
                    try {
                        const res = await fetch(url); const csv = await res.text(); const rows = parseCSV(csv);
                        const cloudData = [];
                        rows.forEach((row, idx) => {
                            if (idx === 0 || !row[0] || !row[2]) return;
                            cloudData.push({ date: row[0], payer: row[1], item: row[2], amount: parseInt(row[3]) || 0, amountTwd: parseInt(row[4]) || 0, id: row[5] || 'L'+idx, remark: row[6] || '' });
                        });
                        expenses.value = cloudData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    } finally { nextTick(() => lucide.createIcons()); }
                };

                const addExpense = async () => {
                    if (!newExpense.value.item || !newExpense.value.amount) return;
                    isSaving.value = true; if (!isEditing.value) newExpense.value.id = 'ID-' + Date.now();
                    const dataToSave = { ...newExpense.value, type: 'expense' };
                    try {
                        await fetch(GAS_WEB_APP_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(dataToSave) });
                        toastMsg.value = "æ”¯å‡ºå·²å­˜æª”ï¼ğŸ’œ"; showToast.value = true; setTimeout(() => showToast.value = false, 2500);
                        cancelEdit(); setTimeout(fetchExpensesFromSheet, 2000);
                    } catch (e) { toastMsg.value = "é€£ç·šå¤±æ•—"; showToast.value = true; } finally { isSaving.value = false; }
                };

                const editItem = (ex) => {
                    newExpense.value = { ...ex }; isEditing.value = true;
                    document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
                };

                const cancelEdit = () => {
                    isEditing.value = false;
                    newExpense.value = { id: null, date: new Date().toISOString().split('T')[0], item: '', amount: null, amountTwd: null, payer: 'KCY', remark: '' };
                };

                // --- å¼·åŒ–çš„è¡Œç¨‹è§£æå™¨ï¼šä½ç½®å°æ‡‰æ³• ---
                const fetchItineraryFromSheet = async () => {
                    syncStatus.value = 'loading';
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${ITINERARY_GID}&t=${Date.now()}`;
                    try {
                        const res = await fetch(url); const csv = await res.text(); const rows = parseCSV(csv);
                        
                        // å®šç¾©åŸºç¤çµæ§‹
                        const newItinerary = [
                            { date: '5/30', dayName: 'SAT', plans: [] }, { date: '5/31', dayName: 'SUN', plans: [] },
                            { date: '6/1', dayName: 'MON', plans: [] }, { date: '6/2', dayName: 'TUE', plans: [] },
                            { date: '6/3', dayName: 'WED', plans: [] }, { date: '6/4', dayName: 'THU', plans: [] },
                            { date: '6/5', dayName: 'FRI', plans: [] }, { date: '6/6', dayName: 'SAT', plans: [] }
                        ];

                        if (rows.length < 1) return;
                        let count = 0;

                        // éæ­·æ‰€æœ‰åˆ—
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            const timeStr = row[0] || '--:--'; // Aæ¬„
                            
                            // éæ­·æ¬„ä½ï¼šB(1) åˆ° I(8)
                            for (let colIdx = 1; colIdx <= 8; colIdx++) {
                                const title = row[colIdx];
                                if (title && title.trim() !== "" && newItinerary[colIdx-1]) {
                                    newItinerary[colIdx-1].plans.push({ 
                                        time: timeStr.trim(), 
                                        title: title.trim() 
                                    });
                                    count++;
                                }
                            }
                        }

                        // æ’åºæ¯ä¸€å¤©çš„è¨ˆç•«
                        newItinerary.forEach(day => {
                            day.plans.sort((a, b) => {
                                const score = (t) => {
                                    const m = String(t).match(/(\d{1,2})[:](\d{2})/);
                                    return m ? parseInt(m[1])*100 + parseInt(m[2]) : 9999;
                                };
                                return score(a.time) - score(b.time);
                            });
                        });
                        
                        itinerary.value = newItinerary; 
                        syncCount.value = count; 
                        syncStatus.value = 'success';
                    } catch (e) { 
                        syncStatus.value = 'error'; 
                    } finally { 
                        setTimeout(() => syncStatus.value = 'idle', 2000); 
                        nextTick(() => lucide.createIcons()); 
                    }
                };

                const weather = ref({ temp: '--', icon: 'thermometer', desc: 'Syncing', status: 'loading' });
                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.40&current_weather=true&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        if (data && data.current_weather) {
                            weather.value.temp = Math.round(data.current_weather.temperature);
                            weather.value.status = 'success';
                            const code = data.current_weather.weathercode;
                            weather.value.icon = code === 0 ? 'sun' : ([1,2,3].includes(code) ? 'cloud-sun' : 'cloud');
                            weather.value.desc = 'Fukuoka';
                        }
                    } catch (e) { weather.value.status = 'error'; }
                };

                const openExternal = (q) => {
                    const targetQuery = (q === 'å›é£¯åº—') ? 'åšå¤šç¥‡åœ’æ«›ç”°ç¥ç¤¾å‰è¥¿éµå…‹é­¯å§†é…’åº—' : q;
                    const url = targetQuery.startsWith('http') ? targetQuery : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(targetQuery)}`;
                    window.open(url, '_blank');
                };

                const handleWeatherClick = () => openExternal('https://tenki.jp/forecast/9/43/8210/40130/');

                onMounted(() => { 
                    fetchItineraryFromSheet(); fetchExpensesFromSheet(); fetchWeather(); fetchExchangeRate();
                    lucide.createIcons();
                });

                return { 
                    activeTab, itineraryView, selectedDay, fxInput, members, expenses, newExpense, itinerary, packing, weather, 
                    syncStatus, exchangeRate, fxDate, addExpense, openExternal, fetchItineraryFromSheet, 
                    convertCurrency, fetchExchangeRate, isSaving, isEditing, showToast, toastMsg, 
                    fetchExpensesFromSheet, handleWeatherClick, editItem, cancelEdit, syncCount, goToDetail,
                    isEditingPlan, startEditPlan, savePlanChange, editPlanBuffer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
